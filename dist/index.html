<!DOCTYPE html><html><head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script async="" src="https://ga.jspm.io/npm:es-module-shims@1.10.0/dist/es-module-shims.js" crossorigin="anonymous"></script>
    <script type="importmap">
    {
      "imports": {
        "near-api-js": "https://ga.jspm.io/npm:near-api-js@4.0.2/lib/browser-index.js",
        "@near-js/jsonrpc-client": "https://unpkg.com/@near-js/jsonrpc-client@1.4.0/dist/browser-standalone.min.js"
      },
      "scopes": {
        "https://ga.jspm.io/": {
          "@near-js/accounts": "https://ga.jspm.io/npm:@near-js/accounts@1.2.1/lib/index.js",
          "@near-js/crypto": "https://ga.jspm.io/npm:@near-js/crypto@1.2.4/lib/index.js",
          "@near-js/keystores": "https://ga.jspm.io/npm:@near-js/keystores@0.0.12/lib/index.js",
          "@near-js/keystores-browser": "https://ga.jspm.io/npm:@near-js/keystores-browser@0.0.12/lib/index.js",
          "@near-js/providers": "https://ga.jspm.io/npm:@near-js/providers@0.2.2/lib/index.js",
          "@near-js/signers": "https://ga.jspm.io/npm:@near-js/signers@0.1.4/lib/index.js",
          "@near-js/transactions": "https://ga.jspm.io/npm:@near-js/transactions@1.2.2/lib/index.js",
          "@near-js/types": "https://ga.jspm.io/npm:@near-js/types@0.2.1/lib/index.js",
          "@near-js/utils": "https://ga.jspm.io/npm:@near-js/utils@0.2.2/lib/index.js",
          "@near-js/wallet-account": "https://ga.jspm.io/npm:@near-js/wallet-account@1.2.2/lib/index.js",
          "@noble/curves/ed25519": "https://ga.jspm.io/npm:@noble/curves@1.2.0/ed25519.js",
          "@noble/hashes/crypto": "https://ga.jspm.io/npm:@noble/hashes@1.3.3/crypto.js",
          "@noble/hashes/sha256": "https://ga.jspm.io/npm:@noble/hashes@1.3.3/sha256.js",
          "@noble/hashes/sha512": "https://ga.jspm.io/npm:@noble/hashes@1.3.2/sha512.js",
          "@noble/hashes/utils": "https://ga.jspm.io/npm:@noble/hashes@1.3.2/utils.js",
          "base-x": "https://ga.jspm.io/npm:base-x@2.0.6/index.js",
          "borsh": "https://ga.jspm.io/npm:borsh@1.0.0/lib/cjs/index.js",
          "bs58": "https://ga.jspm.io/npm:bs58@4.0.0/index.js",
          "buffer": "https://ga.jspm.io/npm:@jspm/core@2.0.1/nodelibs/browser/buffer.js",
          "crypto": "https://ga.jspm.io/npm:@jspm/core@2.0.1/nodelibs/browser/crypto.js",
          "depd": "https://ga.jspm.io/npm:depd@2.0.0/lib/browser/index.js",
          "generate-function": "https://ga.jspm.io/npm:generate-function@2.3.1/index.js",
          "generate-object-property": "https://ga.jspm.io/npm:generate-object-property@1.2.0/index.js",
          "http": "https://ga.jspm.io/npm:@jspm/core@2.0.1/nodelibs/browser/http.js",
          "http-errors": "https://ga.jspm.io/npm:http-errors@1.7.2/index.js",
          "https": "https://ga.jspm.io/npm:@jspm/core@2.0.1/nodelibs/browser/https.js",
          "inherits": "https://ga.jspm.io/npm:inherits@2.0.3/inherits_browser.js",
          "is-my-ip-valid": "https://ga.jspm.io/npm:is-my-ip-valid@1.0.1/index.js",
          "is-my-json-valid": "https://ga.jspm.io/npm:is-my-json-valid@2.20.6/index.js",
          "is-property": "https://ga.jspm.io/npm:is-property@1.0.2/is-property.js",
          "jsonpointer": "https://ga.jspm.io/npm:jsonpointer@5.0.1/jsonpointer.js",
          "lru_map": "https://ga.jspm.io/npm:lru_map@0.4.1/dist/lru.js",
          "mustache": "https://ga.jspm.io/npm:mustache@4.0.0/mustache.js",
          "near-abi": "https://ga.jspm.io/npm:near-abi@0.1.1/lib/index.js",
          "node-fetch": "https://ga.jspm.io/npm:node-fetch@2.6.7/browser.js",
          "process": "https://ga.jspm.io/npm:@jspm/core@2.0.1/nodelibs/browser/process.js",
          "randombytes": "https://ga.jspm.io/npm:randombytes@2.1.0/browser.js",
          "safe-buffer": "https://ga.jspm.io/npm:safe-buffer@5.2.1/index.js",
          "setprototypeof": "https://ga.jspm.io/npm:setprototypeof@1.1.1/index.js",
          "statuses": "https://ga.jspm.io/npm:statuses@1.5.0/dev.index.js",
          "toidentifier": "https://ga.jspm.io/npm:toidentifier@1.0.0/index.js",
          "util": "https://ga.jspm.io/npm:@jspm/core@2.0.1/nodelibs/browser/util.js",
          "xtend": "https://ga.jspm.io/npm:xtend@4.0.2/immutable.js"
        },
        "https://ga.jspm.io/npm:@near-js/crypto@1.2.4/_/HcaMPL-t.js": {
          "@noble/curves/ed25519": "https://ga.jspm.io/npm:@noble/curves@1.2.0/esm/ed25519.js"
        },
        "https://ga.jspm.io/npm:@near-js/crypto@1.2.4/_/LX1h3mee.js": {
          "@noble/curves/ed25519": "https://ga.jspm.io/npm:@noble/curves@1.2.0/esm/ed25519.js"
        },
        "https://ga.jspm.io/npm:@noble/curves@1.2.0/esm/ed25519.js": {
          "@noble/hashes/sha512": "https://ga.jspm.io/npm:@noble/hashes@1.3.2/esm/sha512.js",
          "@noble/hashes/utils": "https://ga.jspm.io/npm:@noble/hashes@1.3.2/esm/utils.js"
        },
        "https://ga.jspm.io/npm:@noble/hashes@1.3.2/": {
          "@noble/hashes/crypto": "https://ga.jspm.io/npm:@noble/hashes@1.3.2/crypto.js"
        },
        "https://ga.jspm.io/npm:@noble/hashes@1.3.2/esm/_sha2.js": {
          "@noble/hashes/crypto": "https://ga.jspm.io/npm:@noble/hashes@1.3.2/esm/crypto.js"
        },
        "https://ga.jspm.io/npm:@noble/hashes@1.3.2/esm/sha512.js": {
          "@noble/hashes/crypto": "https://ga.jspm.io/npm:@noble/hashes@1.3.2/esm/crypto.js"
        },
        "https://ga.jspm.io/npm:@noble/hashes@1.3.2/esm/utils.js": {
          "@noble/hashes/crypto": "https://ga.jspm.io/npm:@noble/hashes@1.3.2/esm/crypto.js"
        },
        "https://ga.jspm.io/npm:http-errors@1.7.2/": {
          "depd": "https://ga.jspm.io/npm:depd@1.1.2/lib/browser/index.js"
        }
      }
    }
    </script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
</head>
<body>
    <app-near-account-report></app-near-account-report>


<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js" integrity="sha384-oBqDVmMz9ATKxIep9tiCxS/Z9fNfEXiDAYTujMAeBAsjFuCZSmKbSSUnQlmh/jp3" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.min.js" integrity="sha384-cuYeSxntonz0PPNlHhBs68uyIAVpIIOZZ5JqeqvYYIcEL727kskC66kF92t6Xl2V" crossorigin="anonymous"></script>
<script type="module">import{viewFunction as t,NearRpcClient as e,viewAccount as n,tx as a,status as o,viewFunctionAsJson as s}from"@near-js/jsonrpc-client";import i from"near-api-js";import"https://cdn.jsdelivr.net/npm/near-api-js@0.44.2/dist/near-api-js.min.js";let r;function c(t,e,n){if(null!==t){r||(r=document.createElement("progress-bar"),document.documentElement.appendChild(r)),r.setValue(t,e,n);return{stopButtonClicked:r?.stopButtonClicked||!1}}if(r){const t=r.stopButtonClicked;return r.remove(),r=null,{stopButtonClicked:t}}return{stopButtonClicked:!1}}function l(){const t=r?.stopButtonClicked||!1;return t&&console.log("isStopRequested: YES, stop was clicked"),t}customElements.define("progress-bar",class extends HTMLElement{constructor(){super(),this.attachShadow({mode:"open"}),this.shadowRoot.innerHTML='\n<style type="text/css">\n:host {\n    position: fixed;\n    top:0;\n\tbottom: 0;\n\tleft: 0;\n\tright: 0;\n    font-family: monospace;\n    margin: auto;\n    z-index: 1000;\n    background-color: rgba(100, 100, 100, 0.5);\n}\n\n.progress-border {\n    position: fixed;\n    top:0;\n\tbottom: 0;\n\tleft: 0;\n\tright: 0;\n  \t\n    margin: auto;\n\n    border: green solid 1px;\n    height: 50px;\n    width: 100%;\n}\n\n.progress-text {\n    position: absolute;\n    color: white;\n    text-align: center;\n    width: 100%;\n    height: 100%;\n    font-size: 22px;\n}\n\n.progress-fill {\n    background-color: rgba(0,255,0, 0.7);\n    height: 50px;    \n    animation-name: indeterminate;\n    animation-duration: 2s;\n    animation-iteration-count: infinite;\n}\n@keyframes indeterminate {\n    0% { margin-left: 0%; width: 10%;}\n    25% { width: 20%; }\n    50% { margin-left: 90%; width: 10%; }\n    75% { width: 20%; }\n    100% { margin-left: 0%; width: 10%; }\n}\n\n.buttons {\n    width: 100%;\n    text-align: center;\n}\n\n#stopbutton {\n    display: none;\n    font-family: monospace;\n    font-sizes: 22px;\n    background-color: black;\n    color: white;\n}\n</style>\n<div id="main-progress-bar" class="progress-border">\n<div class="progress-text">50%</div>\n<div class="progress-fill" style="width:20%"></div>\n<div class="buttons"><button id="stopbutton">Stop</button></div>\n</div>\n',this.stopButton=this.shadowRoot.getElementById("stopbutton"),this.stopButtonClicked=!1,this.stopButton.addEventListener("click",(()=>{this.stopButtonClicked=!0,console.log("Stop button clicked - search will stop")}))}setValue(t,e,n=!1){"indeterminate"==t?(this.shadowRoot.querySelector(".progress-text").innerHTML=`<div style="margin-top: 10px">${e}</div>`,this.shadowRoot.querySelector(".progress-fill").style.width="10%",this.shadowRoot.querySelector(".progress-fill").style.animationName="indeterminate"):(this.shadowRoot.querySelector(".progress-fill").style.animationName="none",this.shadowRoot.querySelector(".progress-text").innerHTML=`${(100*t).toFixed(0)}%${e?`<br />${e}`:""}`,this.shadowRoot.querySelector(".progress-fill").style.width=`${(100*t).toFixed(2)}%`),this.stopButton.style.display=n?"block":"none"}});const d=new Worker(URL.createObjectURL(new Blob([(()=>{const t=function(){let t,e,n=!1;const a="nearearningsdata";let o="ANONYMOUS";XMLHttpRequest.prototype._open=XMLHttpRequest.prototype.open,XMLHttpRequest.prototype.open=function(t,e,n,a,s){this._open(t,e,n,a,s),this.setRequestHeader("Authorization",`Bearer ${o}`)},self.Module={locateFile:function(t){return"https://unpkg.com/wasm-git@0.0.10/"+t},print:function(e){n&&(t+=e+"\n"),postMessage({progress:e}),console.log(e)},printErr:function(t){n&&(e+=t+"\n"),console.error(t)}},importScripts("https://unpkg.com/wasm-git@0.0.10/lg2.js"),importScripts("https://cdnjs.cloudflare.com/ajax/libs/jszip/3.6.0/jszip.min.js");const s=new Promise((t=>{Module.onRuntimeInitialized=()=>{FS.mkdir(`/${a}`),FS.mount("null"==self.origin?MEMFS:IDBFS,{},`/${a}`),FS.chdir(`/${a}`),FS.syncfs(!0,(()=>{t(Module)}))}}));async function i(){await new Promise((t=>FS.syncfs(!1,t)))}self.onmessage=async r=>{await s;try{let s;e="",t="";const c=r.data;switch(c.command){case"configureuser":o=c.accessToken,callMain(["config","user.name",c.username]),callMain(["config","user.email",c.useremail]),s={accessTokenConfigured:!0};break;case"writeFile":FS.writeFile(c.filename,c.content),await i();break;case"readTextFile":s=FS.readFile(c.filename,{encoding:"utf8"});break;case"exists":s=FS.analyzePath(c.path).exists;break;case"mkdir":FS.mkdir(c.path);break;case"readdir":s=FS.readdir(c.path);break;case"git":n=!0,callMain(c),n=!1,["init","commit","add","revert","pull","fetch","merge","clone"].indexOf(c[0])>-1&&await i(),s={stdout:t,stderr:e};break;case"getremote":n=!0,callMain(["remote","show","-v"]),n=!1,s=t;break;case"setremote":callMain(["remote","remove","origin"]),callMain(["remote","add","origin",c.remoteurl]),await i();break;case"sync":if(n=!0,callMain(["fetch","origin"]),callMain(["merge","origin/master"]),callMain(["push"]),n=!1,e)throw e;s=t,await i();break;case"deletelocal":FS.unmount(`/${a}`),console.log("deleting database",a),self.indexedDB.deleteDatabase("/"+a),s={deleted:a};break;case"commitall":n=!0,callMain(["status"]),n=!1;const r=t.split("\n");r.filter((t=>0==t.indexOf("#\tmodified:"))).map((t=>t.substr(11).trim())).forEach((t=>callMain(["add",t])));const l=r.indexOf("# Untracked files:");if(l>-1){let t=r.slice(l+3).map((t=>t.substr(2)));t=t.slice(0,t.length-1),t.length>0&&t.forEach((t=>callMain(["add",t])))}n=!0,callMain(["status"]),n=!1,t.indexOf("Changes to be committed:")>-1?(callMain(["commit","-m","add all untracked data files"]),await i()):console.log("nothing to commit");break;case"exportzip":const d=new JSZip,h=async t=>{const e=FS.readdir(t);for(let n of e){if("."===n||".."===n)continue;const e=`${t}/${n}`,a=FS.stat(e);if(FS.isDir(a.mode))await h(e);else if(FS.isFile(a.mode)){const t=FS.readFile(e);d.file(e,t)}}};await h(`/${a}`);const u=await d.generateAsync({type:"blob"});s={zipUrl:URL.createObjectURL(u)}}postMessage({result:s})}catch(t){postMessage({error:t.toString()})}}}.toString();return t.substring(t.indexOf("{")+1,t.lastIndexOf("}"))})()],{type:"text/javascript"})));let h;const u=async(t,e)=>{for(;h;)await h;return h=new Promise(((n,a)=>{const o=!!r;d.onmessage=t=>{t.data.error?(o||c(null),h=null,a(t.data.error)):t.data.progress?c("indeterminate",t.data.progress):(o||c(null),h=null,n(t.data))},d.postMessage(Object.assign(e,{command:t}))})),h};async function p(t,e){return await u("writeFile",{filename:t,content:e})}async function m(t){return(await u("readTextFile",{filename:t})).result}async function g(t){return(await u("exists",{path:t})).result}async function w(t){await u("mkdir",{path:t})}async function b(){return(await u("commitall",[])).result}async function f(t){return(await u("setremote",{remoteurl:t})).result}async function y(){const t=await async function(){return(await u("exportzip",[])).result.zipUrl}(),e=document.createElement("a");e.href=t,e.download="accountreportfiles.zip",document.body.appendChild(e),e.click(),document.body.removeChild(e),URL.revokeObjectURL(t)}let k=(new Date).getTime(),v=0;async function _(t,e=10,n=3e4){let a;for(let o=0;o<e+1;o++)try{return await t()}catch(t){a=t,o<e&&(console.error("error",t,"retrying in ",n,"milliseconds"),c("indeterminate",`error ${t} retrying in ${(n/1e3).toFixed(0)} seconds`),await new Promise((t=>setTimeout(t,n))))}throw c(null),console.error("max retries reached"),a}async function S(t){const e=document.createElement("common-modal");e.shadowRoot.innerHTML=`<style>\n    :host {\n        position: fixed;\n        display: flex;\n        top:0;\n        bottom: 0;\n        left: 0;\n        right: 0;\n        margin: auto;\n        z-index: 1000;\n        background-color: rgba(255, 255, 255, 0.7);\n    }\n    .modaldiv {\n        margin: auto;\n        text-align: center;\n        padding: 20px;\n        background-color: rgba(0, 0, 0, 0.8);\n        border: #4a4 solid 5px;\n        color: #4a4;\n        font-family: monospace;\n        font-size: 20px;\n        max-width: 800px;\n        border-radius: 50px;\n    }\n    button, textarea, select {\n        font-family: monospace;\n        background-color: #cfc;\n        border-color: #4a4;\n        border-width: 1px;\n        color:#050;\n        padding: 10px;\n        font-size: 20px;\n        \n        border-radius: 4px;\n        white-space: nowrap;\n        \n        margin: 2px;\n        user-select: none;\n    }\n    textarea {\n        width: 80%;\n        height: 80px;\n    }\n</style>\n<div class="modaldiv">\n    ${t}\n</div>`,document.documentElement.appendChild(e);const n=await e.resultPromise;return document.documentElement.removeChild(e),n}async function E(t,e){return S(`\n    <h3>${t}</h3>\n    <p>${e}</p>\n    <p>\n        <button onclick="getRootNode().result(false)">No</button>\n        <button onclick="getRootNode().result(true)">Yes</button>\n    </p>`)}async function T(t,e){return S(`\n    <h3>${t}</h3>\n    <p>${e}</p>\n    <p>\n        <button onclick="getRootNode().result(true)">Dismiss</button>\n    </p>`)}customElements.define("common-modal",class extends HTMLElement{constructor(){super(),this.attachShadow({mode:"open"}),this.resultPromise=new Promise((t=>this.shadowRoot.result=t))}});const R=new i.keyStores.BrowserLocalStorageKeyStore,x="arizportfolio.near",$="ariz_gateway_access_token",C={nodeUrl:"https://rpc.mainnet.near.org",walletUrl:"https://app.mynearwallet.com",networkId:"mainnet",keyStore:R};async function N(){const t=await i.connect(C);return new i.WalletConnection(t,"Ariz portfolio")}async function B(){return(await N()).isSignedIn()}async function A(){const t=localStorage.getItem($);if(t){const n=(await N()).account(),a=t.split("."),o=atob(a[0],"base64"),s=JSON.parse(o),i=(new TextEncoder).encode(o),r=new Uint8Array(await crypto.subtle.digest("SHA-256",i)),l=await n.viewFunction({contractId:x,methodName:"get_account_id_for_token",args:{token_hash:Array.from(r)}});if(l==(e=s).accountId&&e.iat<=(new Date).getTime()&&e.iat>(new Date).getTime()-3e5)return t;if(l===n.accountId){c("indeterminate","Renewing Ariz gateway access token");const t=await I(r);return c(null),t}}var e;c("indeterminate","Create Ariz gateway access token"),await I(),c(null)}async function L(t){const e=new Blob([t],{type:"application/octet-stream"}),n=new FileReader;return new Promise(((t,a)=>{n.onload=function(e){const n=e.target.result.split(",")[1];t(n)},n.onerror=function(t){a(t)},n.readAsDataURL(e)}))}async function I(t){const{token:e,tokenHash:n,signatureBytes:a,publicKeyBytes:o,walletConnection:s}=await async function(){const t=await N(),e=t.getAccountId(),n=await R.getKey(C.networkId,e),a=JSON.stringify({iat:(new Date).getTime(),accountId:e,publicKey:n.getPublicKey().toString()}),o=(new TextEncoder).encode(a),s=new Uint8Array(await crypto.subtle.digest("SHA-256",o)),i=(await n.sign(s)).signature;return{token:`${await L(o)}.${await L(i)}`,tokenHash:s,signatureBytes:i,publicKeyBytes:n.getPublicKey().data,walletConnection:t}}(),r={token_hash:Array.from(n),signature:Array.from(a),public_key:Array.from(o)},c=s.account();if(t){r.old_token_hash=Array.from(t),r.new_token_hash=r.token_hash;try{await c.functionCall({contractId:x,methodName:"replace_token",args:r}),localStorage.setItem($,e)}catch(t){await E("Error renewing token",`<p>There was a problem renewing your access token:</p>\n                ${t.message}\n                <p>\n                Do you want to delete the existing access token, so that a new will be registered on the next attempt (costs 0.2 NEAR) ?\n                </p>`)&&localStorage.removeItem($)}}else localStorage.setItem($,e),await c.functionCall({contractId:x,methodName:"register_token",args:r,attachedDeposit:i.utils.format.parseNearAmount("0.2")});return e}async function M(t){if(!await B())return{};try{const e=await A();c("indeterminate","Loading data from Ariz gateway");const n=await fetch(`https://arizgateway.azurewebsites.net${t}`,{headers:{authorization:`Bearer ${e}`}}).then((t=>t.json()));return c(null),n}catch(t){throw c(null),t}}let O=null;async function D(){if(!O){const t="undefined"!=typeof process&&process.env?.TEST_RPC_ENDPOINT||window.TEST_RPC_ENDPOINT;if(t)console.log("Using test RPC endpoint:",t),O=new e(t);else{const t=await A();O=new e({endpoint:"https://near-rpc-proxy-production.arizportfolio.workers.dev",headers:{Authorization:`Bearer ${t}`}})}}return O}async function q(t){const e="undefined"!=typeof process&&process.env?.TEST_RPC_ENDPOINT||window.TEST_RPC_ENDPOINT||"https://near-rpc-proxy-production.arizportfolio.workers.dev";try{const n={"Content-Type":"application/json"};if(!window.TEST_RPC_ENDPOINT){const t=await A();n.Authorization=`Bearer ${t}`}const a=await fetch(e,{method:"POST",headers:n,body:JSON.stringify(t)});if(!a.ok)throw new Error(`HTTP error! status: ${a.status}`);const o=await a.json();if(o.error)throw new Error(o.error.message||"RPC Error");return o}catch(t){throw console.error("queryMultipleRPC error:",t),t}}async function F(t,e){const n=await D();return await a(n,{txHash:t,senderAccountId:e,waitUntil:"NONE"})}async function z(t,e){return await async function(t,e){const a=await D(),o={accountId:t,finality:"final"===e?"final":void 0,blockId:"final"===e?void 0:e};return await n(a,o)}(e,t)}function H(t){const e=t.receipts_outcome,n=new Map;function a(t,e=0){const o=n.get(t);if(!o)return[];const s=(o.outcome.receipt_ids||[]).flatMap((t=>a(t,e+1)));return[{receipt:o,depth:e},...s]}e.forEach((t=>{n.set(t.id,t)}));return(t.transaction_outcome.outcome.receipt_ids||[]).flatMap((t=>a(t))).reduce(((t,n)=>n.depth>t.depth||n.depth===t.depth&&e.indexOf(n.receipt)>e.indexOf(t.receipt)?n:t))}async function U(t,e){const n=await async function(t,e){return(await q((async n=>fetch(n,{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify({jsonrpc:"2.0",id:"dontcare",method:"tx",params:{tx_hash:t,sender_account_id:e,wait_until:"NONE"}})})))).result}(e,t),a=H(n);return{transaction:n,balance:(await z(a.receipt.block_hash,t)).amount}}async function j(t,e,n){const a=n;let o,s,i,r,c,l=0;for(;!o&&(r=BigInt(n),c=await fetch(`https://mainnet.neardata.xyz/v0/block/${r.toString()}`).then((t=>t.json())),c.shards.forEach((n=>{const a=n.chunk?.transactions?.find((t=>t.transaction.hash===e));if(a)o=a;else{const t=n.receipt_execution_outcomes?.filter((t=>t.tx_hash===e));t&&t.length>0&&(i=t.map((t=>t.receipt.receipt_id)).length>0)}const r=n.state_changes.find((n=>"account_update"===n.type&&n.cause.tx_hash===e&&n.change.account_id===t));r&&(s=r.change.amount)})),!o);){if(i)l=0;else if(l++,10===l)throw new Error(`No transaction or receipts found for transaction ${e} by ${t} in block ${a}`);r--,n=r.toString()}let d=o.outcome.execution_outcome.outcome.receipt_ids;for(;d.length>0;)d.forEach((e=>{c?.shards?.forEach((n=>{const a=n.receipt_execution_outcomes.find((t=>t.execution_outcome.id===e)),o=n.state_changes.find((e=>"account_update"===e.type&&d.includes(e.cause.receipt_hash)&&e.change.account_id===t));o&&(s=o.change.amount),a&&(d=d.filter((t=>t!==e)).concat(a.execution_outcome.outcome.receipt_ids))}))})),d.length>0&&(r+=1n,c=await fetch(`https://mainnet.neardata.xyz/v0/block/${r.toString()}`).then((t=>t.json())));return s||(s=(await z(c.block.header.hash,t)).amount),{transaction:o,balance:s,blockdata:c}}const P=new Map,J=new Map,V=t=>new Promise((e=>setTimeout(e,t)));class K extends Error{constructor(t="Rate limit exceeded (429)"){super(t),this.name="RateLimitError",this.statusCode=429}}class W extends Error{constructor(t="Unauthorized (401) - access token needs renewal"){super(t),this.name="UnauthorizedError",this.statusCode=401}}let Y=!1;function G(t){Y=t}function X(){return Y}function Z(t){if(401===t.statusCode||401===t.code||401===t.status||t.message&&(t.message.includes("401")||t.message.includes("Unauthorized"))||t.cause&&401===t.cause.status||t.cause&&401===t.cause.code)throw console.warn("Unauthorized (401) detected - access token needs renewal"),new W;if("JsonRpcNetworkError"===t.name||t.message?.includes("JsonRpcNetworkError")||t.message?.includes("Network request failed")||t.message?.includes("ERR_FAILED"))throw console.error("Network error detected (likely rate limit), stopping search:",t),Y=!0,new K("Network error - stopping to prevent rate limiting");if(429===t.statusCode||429===t.code||429===t.status||t.message&&(t.message.includes("429")||t.message.includes("Too Many Requests"))||t.cause&&429===t.cause.status||t.cause&&429===t.cause.code)throw console.error("Rate limit detected, throwing RateLimitError",t),Y=!0,new K}async function Q(t,e,...n){if(Y)throw new Error("Operation cancelled - rate limit detected");try{return await t(e,...n)}catch(e){const a=JSON.stringify(e);if(a.includes("401")||a.includes("Unauthorized")){console.warn("Detected 401 Unauthorized - invalidating proxy client and retrying"),console.log("Invalidating proxy client - will be recreated with fresh access token"),O=null;const e=await D();try{return await t(e,...n)}catch(t){throw Z(t),t}}if("JsonRpcNetworkError"===e.name||a.includes("JsonRpcNetworkError"))throw console.error("JsonRpcNetworkError detected - stopping to prevent rate limiting:",e),Y=!0,new K("Network error - stopping to prevent rate limiting");if(e.message&&e.message.includes("ERR_FAILED"))throw console.warn("Network error detected (possibly rate limit), stopping search"),Y=!0,new K("Network error - possible rate limit");if(a.includes("429")||a.includes("Too Many Requests"))throw console.error("Detected 429 in RPC response"),Y=!0,new K;throw Z(e),e}}async function tt(){return await D()}async function et(t){const e="string"==typeof t?t:t.toISOString();if(P.has(e))return P.get(e);const n=new Date,a=new Date(e),s=Math.floor((n-a)/1e3),i=await async function(){if(Y)throw new Error("Operation cancelled by user");try{const t=await tt(),e=await Q(o,t);if(e?.syncInfo?.latestBlockHeight)return e.syncInfo.latestBlockHeight;throw new Error("Could not get current block height")}catch(t){throw console.error("Failed to get current block height:",t),Z(t),t}}()-s;return P.set(e,i),i}async function nt(t,e){const a=await tt(),o={accountId:t,finality:"final"===e?"final":void 0,blockId:"final"===e?void 0:e};if(Y)throw new Error("Operation cancelled by user");try{await V(10);return await Q(n,a,o)}catch(n){if(Z(n),n.message?.includes("does not exist")||"UNKNOWN_ACCOUNT"===n.cause?.name||n.message?.includes("Server error")&&n.data?.includes("does not exist"))return console.log(`Account ${t} does not exist at block ${e}`),{amount:"0",block_height:e,block_hash:"",locked:"0",code_hash:"11111111111111111111111111111111",storage_usage:0,storage_paid_at:0};if(n.message?.includes("Server error")&&"final"!==e&&"number"==typeof e)return console.warn(`Server error at block ${e}, retrying with block ${e-1}`),await nt(t,e-1);throw n}}async function at(t,e,n=[]){const a=await tt(),o={};for(const i of n){if(Y)throw new Error("Operation cancelled by user");try{await V(10);const n=await Q(s,a,{accountId:i,methodName:"ft_balance_of",argsBase64:btoa(JSON.stringify({account_id:t})),blockId:"final"===e?void 0:e});o[i]=n||"0"}catch(t){Z(t),o[i]="0"}}return o}async function ot(t,e,n=void 0,a=void 0,o=!0){const i=`${t}:${e}:${JSON.stringify(n)}:${JSON.stringify(a)}:${o}`;if(J.has(i))return console.log(`getAllBalances ${e} [CACHED]`),J.get(i);console.log(`getAllBalances ${e} tokenContracts: ${null===n?"null":void 0===n?"undefined":Array.isArray(n)?`[${n.length} tokens]`:n} intentsTokens: ${null===a?"null":void 0===a?"undefined":Array.isArray(a)?`[${a.length} tokens]`:a} checkNear: ${o}`);const r={near:"0",fungibleTokens:{},intentsTokens:{}};if(o)try{const n=await nt(t,e);r.near=n?.amount||"0"}catch(t){if(!t.message?.includes("does not exist"))throw t}if(null===n)r.fungibleTokens={};else if(void 0!==n)n.length>0?r.fungibleTokens=await at(t,e,n):r.fungibleTokens={};else{const n=["17208628f84f5d6ad33f0da3bbbeb27ffcb398eac501a31bd6ad2011e36133a1","wrap.near","usdt.tether-token.near"];console.log(`checking DEFAULT tokens at ${e}:`,n),r.fungibleTokens=await at(t,e,n)}if(null===a)r.intentsTokens={};else if(void 0!==a)if(a.length>0){console.log(`checking SPECIFIC intents tokens at ${e}:`,a);const n={};try{if(Y)throw new Error("Operation cancelled by user");const o=await tt();await V(10);const i=await Q(s,o,{accountId:"intents.near",methodName:"mt_batch_balance_of",argsBase64:btoa(JSON.stringify({token_ids:a,account_id:t})),blockId:"final"===e?void 0:e});i&&Array.isArray(i)&&a.forEach(((t,e)=>{n[t]=i[e]||"0"}))}catch(t){Z(t),console.warn("Could not get batch balances for intents tokens:",t.message);for(const t of a)n[t]="0"}r.intentsTokens=n}else r.intentsTokens={};else console.log(`getIntentsBalances - fetching tokens for ${t} at block ${e}`),r.intentsTokens=await async function(t,e){const n=await tt(),a={};if(Y)throw new Error("Operation cancelled by user");try{await V(10);const o=await Q(s,n,{accountId:"intents.near",methodName:"mt_tokens_for_owner",argsBase64:btoa(JSON.stringify({account_id:t})),blockId:"final"===e?void 0:e});if(!o||0===o.length)return a;const i=o.map((t=>"string"==typeof t?t:t.token_id));try{if(Y)throw new Error("Operation cancelled by user");await V(10);const o=await Q(s,n,{accountId:"intents.near",methodName:"mt_batch_balance_of",argsBase64:btoa(JSON.stringify({token_ids:i,account_id:t})),blockId:"final"===e?void 0:e});o&&Array.isArray(o)&&i.forEach(((t,e)=>{a[t]=o[e]||"0"}))}catch(t){Z(t),console.warn("Could not get balances for intents tokens:",t.message);for(const t of o)a[t]="0"}}catch(t){Z(t)}return a}(t,e),console.log(`getIntentsBalances - tokens found: ${Object.keys(r.intentsTokens).length}`);return J.set(i,r),r}async function st(t,e,n,a=void 0,o=void 0,s=!0){const i=n-e;console.log("findLatestBalanceChangingBlock",e,i,a,o,s);const r=function(t,e){const n={hasChanges:!1,nearChanged:!1,tokensChanged:{},intentsChanged:{}},a=BigInt(t.near||"0"),o=BigInt(e.near||"0");a!==o?(n.hasChanges=!0,n.nearChanged=!0,n.nearDiff=o-a):delete n.nearDiff;const s=new Set([...Object.keys(t.fungibleTokens||{}),...Object.keys(e.fungibleTokens||{})]);for(const a of s){const o=BigInt(t.fungibleTokens?.[a]||"0"),s=BigInt(e.fungibleTokens?.[a]||"0");o!==s&&(n.hasChanges=!0,n.tokensChanged[a]={start:o.toString(),end:s.toString(),diff:(s-o).toString()})}const i=new Set([...Object.keys(t.intentsTokens||{}),...Object.keys(e.intentsTokens||{})]);for(const a of i){const o=BigInt(t.intentsTokens?.[a]||"0"),s=BigInt(e.intentsTokens?.[a]||"0");o!==s&&(n.hasChanges=!0,n.intentsChanged[a]={start:o.toString(),end:s.toString(),diff:(s-o).toString()})}return n}(await ot(t,e,a,o,s),await ot(t,n,a,o,s));if(!r.hasChanges)return r.block=e,r;if(1===i)return r.block=n,r;const c=n-Math.floor(i/2),l=r.nearChanged||!1,d=[];r.tokensChanged&&Object.keys(r.tokensChanged).forEach((t=>{d.includes(t)||d.push(t)}));const h=[];r.intentsChanged&&Object.keys(r.intentsChanged).forEach((t=>{h.push(t)}));const u=await st(t,c,n,d.length>0?d:null,h.length>0?h:null,l);return u.hasChanges?u:await st(t,e,c,d.length>0?d:null,h.length>0?h:null,l)}async function it(t,e){if(Y)throw new Error("Operation cancelled by user");try{const n=`https://a2.mainnet.neardata.xyz/v0/block/${e}`;console.log(`Fetching block data from ${n}`);const a=await fetch(n);if(!a.ok)throw new Error(`Failed to fetch block data: ${a.status}`);const o=await a.json(),s=o.block?.header?.timestamp;console.log(`Searching for receipts affecting ${t} in block ${e}`);const i=new Set,r=[];for(const e of o.shards||[])for(const n of e.receipt_execution_outcomes||[]){const e=n.receipt,a=n.execution_outcome,s=n.tx_hash,c=e.receiver_id,l=e.predecessor_id,d=a?.outcome?.logs||[];let h=!1;if(c!==t&&l!==t||(h=!0),!h)for(const e of d)if(e.startsWith("EVENT_JSON:"))try{const n=JSON.parse(e.substring(11));if(JSON.stringify(n).includes(t)){h=!0,console.log("Found EVENT mentioning target account:",n);break}}catch(t){}if(h&&s&&!i.has(s)){console.log("Found receipt affecting target account:"),console.log("  tx_hash:",s),console.log("  receiverId:",c),console.log("  predecessorId:",l),console.log("  receiptId:",e.receipt_id),i.add(s);for(const t of o.shards||[])for(const e of t.chunk?.transactions||[])if(e.hash===s){r.push(e);break}}}if(r.length>0||i.size>0){const t=[];for(const e of o.shards||[])for(const n of e.receipt_execution_outcomes||[]){const e=n.tx_hash,a=n.receipt;if(i.has(e)&&a.receipt?.Action?.signer_id){const n=a.receipt.Action.signer_id;try{console.log(`Fetching transaction ${e} with signer ${n}`);const a=await F(e,n);if(a?.transaction){const n=a.transaction;t.push({hash:e,signerId:n.signerId,receiverId:n.receiverId,actions:n.actions||[]})}}catch(t){console.error(`Error fetching transaction ${e}:`,t.message)}}}return{transactions:t.length>0?t:r,transactionHashes:Array.from(i),transactionBlock:e,receiptBlock:e,blockTimestamp:s}}}catch(t){console.error("Error fetching block data from neardata.xyz:",t.message)}return{transactions:[],transactionHashes:[],transactionBlock:null,receiptBlock:e,blockTimestamp:null}}async function rt(t,e,n){if(Y)throw new Error("Operation cancelled by user");const a=await st(t,e,n);if(a.hasChanges)return a.searchStart=e,a;let o=e,s=e,i=n-e,r=0;for(;r<10&&o>0;){if(Y)throw new Error("Operation cancelled by user");i*=2,o=Math.max(0,s-i),console.log(`No changes found in blocks ${e}-${n}, expanding to ${o}-${s} (expansion ${r+1})`);const a=await st(t,o,s);if(a.hasChanges)return a.searchStart=o,a;r++,s=o}return{hasChanges:!1,block:e}}const ct="accountdata",lt="accounts.json",dt="depositaccounts.json",ht="ignorefungibletokens.json",ut="customexchangerates.json",pt="currencylist.json",mt="realizations.json",gt={},wt={};async function bt(){const t=await kt();for(const e of t){(await _t(e)).forEach((t=>{gt[t.ft.symbol]=!0}))}return Object.keys(gt)}function ft(t){return`${ct}/${t}/fungible_token_transactions.json`}async function yt(){const t={};return await g(dt)?Object.assign(t,JSON.parse(await m(dt))):(await async function(t){await p(dt,JSON.stringify(t))}(t),t)}async function kt(){return JSON.parse(await m(lt))}async function vt(t){const e=(await _t(t)).reduce(((t,e)=>(t[e.transaction_hash]=e,t)),{});return e}async function _t(t){const e=ft(t);if(await g(e)){return JSON.parse(await m(e)).map((t=>({...t,args:t.args||{}})))}return[]}async function St(t,e){if(e)return(await _t(t)).filter((t=>t.ft.symbol===e)).map((t=>({...t,hash:t.transaction_hash})));{const e=`${ct}/${t}/transactions.json`;if(await g(e)){return JSON.parse(await m(e)).map((t=>({...t,args:t.args||{}})))}return[]}}async function Et(t){const e=t.split("/");for(let t=0;t<e.length-1;t++){const n=e.slice(0,t+1).join("/");await g(n)||await w(n)}}async function Tt(t){await g(ct)||await w(ct);const e=`${ct}/${t}`;await g(e)||await w(e)}async function Rt(t,e=null,n=null){let a,o;if(G(!1),"string"!=typeof n||"final"!==n&&isNaN(parseInt(n)))n||(n=new Date),e||(e=new Date).setDate(e.getDate()-1),console.log(`Fetching transactions for ${t} using balance tracker`),console.log(`From: ${e.toISOString()}`),console.log(`To: ${n.toISOString()}`),a=await et(e),o=await et(n);else if("final"===n?(o=await et(new Date),console.log(`Fetching transactions for ${t} using balance tracker`),console.log(`To block: final (${o})`)):(o=parseInt(n),console.log(`Fetching transactions for ${t} using balance tracker`),console.log(`To block: ${o}`)),e)"number"==typeof e?(a=e,console.log(`From block: ${a} (after last existing transaction receipt)`)):"string"!=typeof e||isNaN(parseInt(e))?e instanceof Date&&(a=await et(e),console.log(`From: ${e.toISOString()} (block ${a})`)):(a=parseInt(e),console.log(`From block: ${a}`));else{console.log(`Fetching account creation block from NearBlocks API for ${t}...`);try{const e=await fetch(`https://api.nearblocks.io/v1/account/${t}`),n=await e.json(),o=n.account[0]?.created?.transaction_hash;if(o){const t=await fetch(`https://api.nearblocks.io/v1/txns/${o}`),e=await t.json(),n=e.txns[0]?.block?.block_height;n?(a=Math.max(9820210,n-100),console.log(`From block: ${a} (100 blocks before account creation at ${n})`)):(a=9820210,console.log(`From block: ${a} (genesis - couldn't determine creation block)`))}else a=9820210,console.log(`From block: ${a} (genesis - account not found in NearBlocks)`)}catch(t){console.warn("Error fetching account creation from NearBlocks:",t.message),a=9820210,console.log(`From block: ${a} (genesis - NearBlocks API error)`)}}console.log(`Start block: ${a}`),console.log(`End block: ${o}`);let s=await St(t),i=await _t(t);const r=new Set(s.map((t=>t.hash))),d=new Set(i.map((t=>t.transaction_hash))),h=new Set(r),u=new Set(d);let m=o,g=Math.min(86400,o-a);let w=0;const b=[],f=[];let y=!1;for(;m>a&&w<100;){w++;const e=Math.max(a,m-g);if(l()){console.log("User stopped the search (before progress update)"),G(!0);break}if(c((o-m)/(o-a),`${t}: Searching blocks ${e} to ${m}`,!0),l()){console.log("User stopped the search (after progress update)"),G(!0);break}try{const n=await rt(t,e,m);if(l()){console.log("User stopped the search (checked after async operation)"),G(!0);break}if(!n.hasChanges){if(console.log(`No changes found in blocks ${e}-${m}, moving to earlier blocks`),1===w&&0===b.length){console.log("No transactions found in initial search, stopping");break}m=e-1;continue}const a=await it(t,n.block);if(l()){console.log("User stopped the search (after finding transaction)"),G(!0);break}if(0===a.transactions.length){console.log(`No transaction found for balance change at block ${n.block}`),m=n.block-1;continue}const o=a.transactions[0];if(r.has(o.hash)){console.log(`Found existing transaction ${o.hash}, stopping search`),y=!0;break}if(h.has(o.hash)){console.log(`Already found transaction ${o.hash} in this search, skipping duplicate`),m=n.block-1;continue}let s="0";try{const e=await z(a.receiptBlock||n.block,t);s=e?.amount||"0"}catch(t){console.warn(`Could not get balance at block ${n.block}:`,t.message)}const i={hash:o.hash,block_height:a.transactionBlock||n.block,block_timestamp:a.blockTimestamp?BigInt(a.blockTimestamp).toString():BigInt(1e6*Date.now()).toString(),signer_id:o.signerId,receiver_id:o.receiverId,balance:s,action_kind:xt(o),args:{}};if("FUNCTION_CALL"===i.action_kind&&o.actions&&o.actions.length>0){const t=o.actions[0].FunctionCall;t&&(i.args.method_name=t.methodName||t.method_name||void 0)}if(b.push(i),h.add(o.hash),console.log(`Found new transaction ${o.hash} at block ${i.block_height}`),n.tokensChanged)for(const[e,s]of Object.entries(n.tokensChanged)){const i=await $t(e),r={transaction_hash:o.hash,block_height:a.transactionBlock||n.block,block_timestamp:a.blockTimestamp?BigInt(a.blockTimestamp).toString():BigInt(1e6*Date.now()).toString(),account_id:t,delta_amount:s.diff,involved_account_id:o.signerId===t?o.receiverId:o.signerId,balance:s.end,ft:{contract_id:e,symbol:i.symbol,decimals:i.decimals},args:{}};if(o.actions&&o.actions.length>0&&o.actions[0].FunctionCall){const t=o.actions[0].FunctionCall;t&&(r.args.method_name=t.methodName||t.method_name||void 0)}u.has(`${o.hash}-${e}`)||(f.push(r),u.add(`${o.hash}-${e}`))}if(n.intentsChanged)for(const[e,s]of Object.entries(n.intentsChanged)){const i=e.replace("nep141:",""),r=await $t(i),c={transaction_hash:`${o.hash}-intents-${i}`,block_height:a.transactionBlock||n.block,block_timestamp:a.blockTimestamp?BigInt(a.blockTimestamp).toString():BigInt(1e6*Date.now()).toString(),account_id:t,delta_amount:s.diff,involved_account_id:"intents.near",balance:s.end,ft:{contract_id:i,symbol:r.symbol,decimals:r.decimals},args:{}};if(o.actions&&o.actions.length>0&&o.actions[0].FunctionCall){const t=o.actions[0].FunctionCall;t&&(c.args.method_name=t.methodName||t.method_name||void 0)}u.has(c.transaction_hash)||(f.push(c),u.add(c.transaction_hash))}if(void 0!==n.searchStart&&(g=m-n.searchStart),m=(a.transactionBlock||n.block)-1,y)break}catch(t){if(t instanceof K||429===t.statusCode||t.message?.includes("429")||t.message?.includes("Too Many Requests")){console.error("Rate limit exceeded (429), stopping search immediately"),c(null,"Search stopped: Rate limit exceeded");break}if(t.message?.includes("Operation cancelled")){console.log("Search cancelled by user"),c(null,"Search cancelled");break}console.error(`Error processing blocks ${e}-${m}:`,t),m=e-1}}const k=[...s,...b].sort(((t,e)=>e.block_height-t.block_height)),v=[...i,...f].sort(((t,e)=>e.block_height-t.block_height));return await Nt(t,k),await async function(t,e){const n=ft(t);await Et(n),await p(n,JSON.stringify(e,null,1))}(t,v),console.log(`Found ${b.length} new NEAR transactions`),console.log(`Found ${f.length} new fungible token transactions`),y?console.log("Search stopped: Reached existing transactions"):l()||X()?console.log("Search stopped: User requested"):w>=100?console.log("Search stopped: Maximum iterations reached"):console.log("Search completed: Reached start block"),c(null),{transactions:k,ftTransactions:v,newTransactionsCount:b.length,newFtTransactionsCount:f.length,stoppedReason:y?"existing_transactions":l()||X()?"user_stopped":w>=100?"max_iterations":"completed"}}function xt(t){if(!t.actions||0===t.actions.length)return"UNKNOWN";const e=t.actions[0],n=Object.keys(e)[0];switch(n){case"FunctionCall":return"FUNCTION_CALL";case"Transfer":return"TRANSFER";case"Stake":return"STAKE";case"AddKey":return"ADD_KEY";case"DeleteKey":return"DELETE_KEY";case"CreateAccount":return"CREATE_ACCOUNT";case"DeleteAccount":return"DELETE_ACCOUNT";case"DeployContract":return"DEPLOY_CONTRACT";default:return n.toUpperCase()}}async function $t(e){if(wt[e])return wt[e];const n=await async function(e,n,a,o){const s=await D();let i;if(a){const t=JSON.stringify(a);i=btoa(t)}const r={accountId:e,methodName:n,argsBase64:i,finality:"final"===o?"final":void 0,blockId:"final"===o?void 0:o},c=await t(s,r);if(c?.result)try{const t=(new TextDecoder).decode(new Uint8Array(c.result));return JSON.parse(t)}catch(t){return c}return c}(e,"ft_metadata",{},"final");if(!n||void 0===n.decimals)throw new Error(`Failed to fetch valid metadata for token contract ${e}. Missing decimals field.`);const a={symbol:n.symbol,decimals:n.decimals};return wt[e]=a,a}async function Ct(t){let e=await St(t);return await async function({account:t,transactions:e}){const n=e.filter((t=>void 0===t.balance));let a=0;for(const e of n){const{stopButtonClicked:o}=c(a/n.length,`${t} ${new Date(e.block_timestamp/1e6).toDateString()}`,!0);if(o)break;if(!e.block_height){const t=await zt(e.block_hash);e.block_height=t.header.height}const{balance:s,transaction:i}=await _((()=>U(t,e.hash,e.block_height)));e.balance=s,e.signer_id=i.transaction.signer_id,e.receiver_id=i.transaction.receiver_id;const r=i.transaction.actions;if(r&&r.length>0){const t=Object.keys(i.transaction.actions[0])[0];e.action_kind="FunctionCall"===t?"FUNCTION_CALL":t,e.args.method_name=i.transaction.actions[0].FunctionCall?.method_name}else e.action_kind=null,e.args.method_name=null;a++}}({account:t,transactions:e}),await Nt(t,e),e}async function Nt(t,e){await Tt(t),await p(`${ct}/${t}/transactions.json`,JSON.stringify(e,null,1))}function Bt(t){return`${ct}/${t}/stakingpools`}function At(t,e){return`${Bt(t)}/${e}.json`}async function Lt(t,e,n){if(n)return[];const a=At(t,e);return await g(a)?JSON.parse(await m(a)):[]}async function It(t,e){const n=await Lt(t,e),a=await async function(t,e,n,a="final"){let o=await Ht(a);const s=(await St(e)).filter((e=>(e.receiver_id===t||e.signer_id===t)&&e.block_timestamp<o.header.timestamp)),i=s[s.length-1],r=parseInt(i.block_timestamp),l=o.header.timestamp;let d=await Ut(t,e,o.header.height);console.log(`staking pool ${t} balance for account ${e} in block ${o.header.height} is ${d}`),0===d&&(console.log(`Looking for block for last staking transaction from date ${new Date(s[0].block_timestamp/1e6)}`),o=s[0].block_height?await Ht(s[0].block_height):await zt(s[0].block_hash),d=n.find((t=>t.epoch_id===o.header.epoch_id))?.balance,void 0===d&&(d=await Ut(t,e,o.header.height)),console.log(`staking pool ${t} balance for account ${e} in block ${o.header.height} (${new Date(o.header.timestamp/1e6)}}) is ${d}`));let h=n.length>0?n[0].epoch_id:null,u=0;for(;c(1-(o.header.timestamp-r)/(l-r),`${e} / ${t} ${new Date(o.header.timestamp/1e6).toDateString()}`),!(o.header.epoch_id==h||o.header.timestamp<r);){if(null!==d){const t={timestamp:new Date(o.header.timestamp/1e6),balance:d,block_height:o.header.height,epoch_id:o.header.epoch_id,next_epoch_id:o.header.next_epoch_id,deposit:0,withdrawal:0};n.splice(u++,0,t)}let a=o.header.next_epoch_id,s=n.find((t=>o.header.epoch_id===t.next_epoch_id));for(;s;)a=s.next_epoch_id,s=n.find((t=>s.epoch_id===t.next_epoch_id));o=await _((()=>zt(a)));try{d=await _((()=>Ut(t,e,o.header.height)),0)}catch(n){console.warn(`error fetching staking balance ${t} ${e} ${o.header.height}. Skipping.`,n)}}for(let a of s)if(!n.find((t=>t.hash===a.hash))){o=a.block_height?await _((()=>Ht(a.block_height))):await _((()=>zt(a.block_hash)));const s=await _((()=>Ut(t,e,o.header.height)),1),{blockdata:i}=await j(e,a.hash,o.header.height),r=await _((()=>Ut(t,e,i.block.header.height)),1),c=new Date(a.block_timestamp/1e6);let l=0;"withdraw_all"===a.args.method_name&&(l=s-r);let d=0;"deposit_and_stake"===a.args.method_name&&(d=r-s),n.push({timestamp:c,balance:r,hash:a.hash,block_height:o.header.height,epoch_id:o.header.epoch_id,next_epoch_id:o.header.next_epoch_id,deposit:d,withdrawal:l})}n.sort(((t,e)=>e.block_height-t.block_height));for(let t=0;t<n.length-1;t++){const e=n[t];e.deposit||(e.deposit=0),e.withdrawal||(e.withdrawal=0),e.earnings=e.balance-n[t+1].balance-e.deposit+e.withdrawal}return n[n.length-1].earnings=0,n}(e,t,n);await async function(t,e,n){await Tt(t);const a=Bt(t);await g(a)||await w(a);const o=At(t,e);await p(o,JSON.stringify(n,null,1))}(t,e,a)}function Mt(t,e){return`pricehistory/${t}/${e.toLowerCase()}.json`}async function Ot(t,e){t?"wNEAR"===t&&(t="NEAR"):t="NEAR";const n=Mt(t,e);return await g(n)?JSON.parse(await m(n)):{}}async function Dt(t,e,n){const a=Mt(t,e);await Et(a),await p(a,JSON.stringify(n,null,1))}async function qt(){return await g(ut)?JSON.parse(await m(ut)):{}}async function Ft(t){const e={};t.forEach((t=>{e[t.currency]||(e[t.currency]={}),e[t.currency][t.date]={buy:"buy"==t.buysell?t.price:void 0,sell:"sell"==t.buysell?t.price:void 0}})),await async function(t){await p(ut,JSON.stringify(t,null,1))}(e)}async function zt(t){return(await q((async e=>await fetch(e,{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify({jsonrpc:"2.0",id:"dontcare",method:"block",params:{block_id:"final"===t?void 0:t,finality:"final"===t?t:void 0}})})))).result}async function Ht(t){let e="block";return"final"===t&&(e="last_block"),(await fetch(`https://mainnet.neardata.xyz/v0/${e}/${t}`).then((t=>t.json()))).block}async function Ut(t,e,n){const a=await q((async a=>await fetch(a,{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify({jsonrpc:"2.0",id:"dontcare",method:"query",params:{request_type:"call_function",block_id:n,account_id:t,method_name:"get_account_total_balance",args_base64:btoa(JSON.stringify({account_id:e}))}})})));if(a&&!a.error)return parseInt(a.result.result.map((t=>String.fromCharCode(t))).join("").replace(/\"/g,""));throw console.error(a.error),new Error(`Error getting staking account balance for staking pool ${t}, account ${e}, block_id ${n}. Result: ${JSON.stringify(a?.error)}`)}async function jt(t){const e=(await St(t)).filter((t=>"FUNCTION_CALL"===t.action_kind&&"deposit_and_stake"===t.args.method_name)),n=[];return e.forEach((t=>{n.find((e=>e==t.receiver_id))||n.push(t.receiver_id)})),n}customElements.define("accounts-page",class extends HTMLElement{constructor(){super(),this.attachShadow({mode:"open"}),this.readyPromise=this.loadHTML()}async loadHTML(){return this.shadowRoot.innerHTML='\n<template id="accountRowTemplate">\n    <div class="input-group">\n        <input type="text" class="accountname form-control"></td>\n        <button class="btn btn-danger removeAccountButton"><i class="bi bi-trash"></i></button>\n    </div>\n</template>\n\n<div class="card">\n    <div class="card-header">Accounts</div>\n    <div class="card-body">\n        <div id="accountsTable"></div>\n    </div>\n    <div class="card-footer">\n        <button id="addAccountButton" class="btn btn-primary">Add account</button>\n        <div class="d-inline-block ms-2">\n            <label for="startBlockInput" class="me-2">Load up to block:</label>\n            <input type="text" id="startBlockInput" class="form-control d-inline-block" style="width: 150px;" value="final" placeholder="final or block ID">\n        </div>\n        <button type="button" class="btn btn-primary ms-2" id="loaddatabutton">load data</button>\n        <button type="button" class="btn btn-primary" id="fixtransactionswithoutbalancesbutton">correct transactions without balance</button>\n    </div>\n</div>\n',this.accountsTable=this.shadowRoot.querySelector("#accountsTable"),this.shadowRoot.querySelector("#addAccountButton").onclick=async()=>{this.addAccountRow(),await this.storeAccounts()},document.querySelectorAll("link").forEach((t=>this.shadowRoot.appendChild(t.cloneNode()))),this.shadowRoot.getElementById("loaddatabutton").addEventListener("click",(async()=>{c(0);try{const e=this.shadowRoot.getElementById("startBlockInput").value.trim()||"final";for(const n of this.getAccounts()){let a;c(.1,`Starting balance-based search for ${n} up to block ${e}...`),a="final"===e?Number.MAX_SAFE_INTEGER:parseInt(e);const o=await St(n);let s=null;if(o&&o.length>0&&!isNaN(a)){const t=o.filter((t=>t.block_height&&t.block_height<a)).sort(((t,e)=>e.block_height-t.block_height));t.length>0&&(s=t[0].block_height+20,console.log(`Found existing transaction at block ${t[0].block_height}, starting from block ${s} (after receipt)`))}const i=await Rt(n,s,e);if(console.log(`Loaded ${i.newTransactionsCount} new transactions for ${n}`),console.log(`Loaded ${i.newFtTransactionsCount} new token transactions`),i.transactions.length>0){const e=await(t=i.transactions,[...new Set(t.filter((t=>"FUNCTION_CALL"===t.action_kind&&"deposit_and_stake"===t.args.method_name)).map((t=>t.receiver_id)))]);for(const t of e)await It(n,t)}}c(null)}catch(t){c(null),T("Error fetching data",t.message),console.error("Error:",t)}var t;this.dispatchChangeEvent()})),this.shadowRoot.getElementById("fixtransactionswithoutbalancesbutton").addEventListener("click",(async()=>{c(0);try{for(const t of this.getAccounts())await Ct(t);c(null)}catch(t){c(null),T("Error fixing transactions without balance",t.message)}this.dispatchChangeEvent()})),await g(lt)&&this.setAccounts(await kt()),this.shadowRoot}dispatchChangeEvent(){this.dispatchEvent(new Event("change"))}addAccountRow(t){const e=this.shadowRoot.querySelector("#accountRowTemplate");this.accountsTable.appendChild(e.content.cloneNode(!0));const n=this.accountsTable.lastElementChild,a=n.querySelector(".accountname");t&&(a.value=t),a.addEventListener("change",(async t=>{await this.storeAccounts(),this.dispatchChangeEvent()})),n.querySelector(".removeAccountButton").onclick=async()=>{n.remove(),await this.storeAccounts()}}setAccounts(t){this.accountsTable.replaceChildren([]),t.forEach((t=>this.addAccountRow(t)))}getAccounts(){return Array.from(this.accountsTable.querySelectorAll(".accountname")).map((t=>t.value))}async storeAccounts(){await async function(t){await p(lt,JSON.stringify(t))}(this.getAccounts())}});const Pt="NEAR",Jt={};async function Vt(){let t=await async function(){return await g(pt)?JSON.parse(await m(pt)):[]}();if(0===t.length){const e=await M("/api/prices/currencylist");t=Object.keys(e),await async function(t){await p(pt,JSON.stringify(t,null,1))}(t)}return t}async function Kt(){const t=await async function(t){if(v++,v>5){const t=k+6e4-(new Date).getTime();t>0&&await new Promise((e=>setTimeout((()=>e()),t)))}k<(new Date).getTime()-6e4&&(k=(new Date).getTime(),v=0);const e=async()=>await fetch(`https://api.nearblocks.io${t}`,{mode:"cors"});let n=await e();if(429===n.status&&(console.error("too many requests",n,"retry in 60 seconds"),await new Promise((t=>setTimeout((()=>t()),6e4))),n=await e()),200===n.status)return"true"===n.headers.get("x-cache-hit")&&v>0&&v--,await n.json();throw console.error(n),new Error(`${n.status}: ${await n.text()}`)}("/v1/charts"),e=await Ot(Pt,"USD");t.charts.forEach((t=>e[t.date.substring(0,10)]=Number(t.near_price))),await Dt(Pt,"USD",e)}async function Wt(t,e,n=Pt){if(""===n&&(n=Pt),0!==n.indexOf("USD")&&"USN"!==n||(n="USD"),"USD"===n&&"USD"===t)return 1;let a=await Ot(n,t);const o=`${n}-${t}`;if(void 0===a[e]&&!Jt[o])if(await E("Fetch price data from Ariz gateway?",`Price for ${n}-${t} on ${e} is missing locally.\n            Would you like to try fetch updated prices from Ariz Gateway?\n        `))try{await async function({baseToken:t="near",currency:e,todate:n=(new Date).toJSON()}){const a=await M(`/api/prices/history?basetoken=${t.toLowerCase()}&currency=${e}&todate=${n}`);await Dt(t,e,a)}({baseToken:n,currency:t}),a=await Ot(n,t)}catch(e){await T("Error fetching price data from Ariz Gateway",`There was an error fetching prices for ${n} / ${t} from Ariz Gateway:\n                ${e.message}\n                `)}else Jt[o]=!0;return a[e]??0}async function Yt(t,e,n){if(n&&"near"!==n)return await Wt(t,e,n);const a=await qt();return a[t]?.[e]?.sell??await Wt(t,e)}customElements.define("transactions-page",class extends HTMLElement{constructor(){super(),this.attachShadow({mode:"open"}),this.readyPromise=this.loadHTML()}async loadHTML(){this.shadowRoot.innerHTML='<style>\n    .numeric {\n        text-align: right;\n    }\n\n    .transactionrow_datetime {\n        white-space: nowrap;\n    }\n\n    .table-responsive {\n        max-height: 100%;\n    }\n\n    table thead,\n    table tfoot {\n        position: sticky;\n    }\n\n    table thead {\n        inset-block-start: 0;\n        top: 0;\n    }\n\n    table tfoot {\n        inset-block-end: 0;\n        bottom: 0;\n    }\n    .transactionrow_signer {\n        text-overflow: clip;\n    }\n    .transactionrow_receiver {\n        text-overflow: clip;\n    }\n</style>\n<h3>Transactions</h3>\n<div class="row">\n<div class="col-md-6">\n    <label for="accountselect" class="form-label">Account</label>\n    <select class="form-select" aria-label="Select account" id="accountselect">\n        <option disabled selected value>Select account</option>\n    </select>\n</div>\n<div class="col-md-6">\n    <label for="currencyselect" class="form-label">Currency</label>\n    <select class="form-select" aria-label="Select currency" id="currencyselect">\n        <option value="near">NEAR</option>\n    </select>\n</div>\n<template id="transactionrowtemplate">\n    <tr>\n        <td class="transactionrow_datetime"></td>\n        <td class="transactionrow_kind"></td>\n        <td class="transactionrow_balance numeric"></td>\n        <td class="transactionrow_change numeric"></td>\n        <td class="transactionrow_signer"></td>\n        <td class="transactionrow_receiver"></td>\n        <td class="transactionrow_hash"></td>\n    </tr>\n</template>\n<div class="table-responsive">\n    <table class="table table-sm">\n        <thead class="table-dark">\n            <th scope="col">\n                date\n            </th>\n            <th scope="col">\n                kind\n            </th>\n            <th scope="col">\n                balance\n            </th>\n            <th scope="col">\n                change\n            </th>\n            <th scope="col">\n                signer\n            </th>\n            <th scope="col">\n                receiver\n            </th>\n            <th scope="col">\n                hash\n            </th>\n        </thead>\n        <tbody id="transactionstable">\n\n        </tbody>\n    </table>\n</div>\n',this.transactionsTable=this.shadowRoot.getElementById("transactionstable"),document.querySelectorAll("link").forEach((t=>this.shadowRoot.appendChild(t.cloneNode())));const t=this.shadowRoot.querySelector("#accountselect");await Promise.all((await kt()).map((async e=>{const n=document.createElement("option");n.value=e,n.text=e,t.appendChild(n)})));const e=this.shadowRoot.querySelector("#currencyselect");(await Vt()).forEach((t=>{const n=document.createElement("option");n.value=t,n.text=t.toUpperCase(),e.appendChild(n)}));const n=()=>{const n=t.value,a=e.value;this.updateView(n,a,2)};return t.addEventListener("change",n),e.addEventListener("change",n),this.shadowRoot}async updateView(t,e,n){const a=await St(t),o=this.shadowRoot.querySelector("#transactionrowtemplate");for(;this.transactionsTable.lastElementChild;)this.transactionsTable.removeChild(this.transactionsTable.lastElementChild);for(let t=0;t<a.length;t++){this.transactionsTable.appendChild(o.content.cloneNode(!0));const s=this.transactionsTable.lastElementChild,i=a[t],r=t<a.length-1?a[t+1].balance:0,c=(i.balance-r)/1e24,l=new Date(i.block_timestamp/1e6).toJSON().substring(0,10),d="near"==e?1:await Wt(e,l);s.querySelector(".transactionrow_datetime").innerHTML=l,s.querySelector(".transactionrow_kind").innerHTML=`${i.action_kind}${"FUNCTION_CALL"==i.action_kind?`(${i.args.method_name})`:""}`,s.querySelector(".transactionrow_balance").innerHTML=(d*(parseInt(i.balance)/1e24)).toFixed(n);const h=d*c;s.querySelector(".transactionrow_change").innerHTML=h.toFixed(n),s.querySelector(".transactionrow_signer").innerHTML=i.signer_id,s.querySelector(".transactionrow_receiver").innerHTML=i.receiver_id,s.querySelector(".transactionrow_hash").innerHTML=i.hash}const s=this.shadowRoot.querySelector(".table-responsive");s.style.height=window.innerHeight-s.getBoundingClientRect().top+"px"}});customElements.define("staking-page",class extends HTMLElement{constructor(){super(),this.attachShadow({mode:"open"}),this.readyPromise=this.loadHTML()}async loadHTML(){this.shadowRoot.innerHTML='<style>\n    .numeric {\n        text-align: right;\n    }\n\n    .stakingrewardrow_datetime {\n        white-space: nowrap;\n    }\n\n    .stakingrewardrow_balance {\n        white-space: nowrap;\n    }\n\n    .table-responsive {\n        max-height: 100%;\n    }\n\n    table thead,\n    table tfoot {\n        position: sticky;\n    }\n\n    table thead {\n        inset-block-start: 0;\n        top: 0;\n    }\n\n    table tfoot {\n        inset-block-end: 0;\n        bottom: 0;\n    }\n</style>\n<template id="stakingpoolselectoption">\n    <input type="radio" class="btn-check" name="stakingpoolselectoptions" autocomplete="off" checked>\n    <label class="btn btn-outline-success"></label>\n</template>\n<h3>Staking balance and rewards</h3>\n<div class="row">\n<div class="col-md-6">\n    <label for="accountselect" class="form-label">Account</label>\n    <select class="form-select" aria-label="Select account" id="accountselect">\n        <option disabled selected value>Select account</option>\n    </select>\n</div>\n<div class="col-md-6">\n    <label for="currencyselect" class="form-label">Currency</label>\n    <select class="form-select" aria-label="Select currency" id="currencyselect">\n        <option value="near">NEAR</option>\n    </select>\n</div>\n<div id="stakingpoolselect">\n\n</div>\n<template id="stakingrewardrowtemplate">\n    <tr>\n        <td class="stakingrewardrow_datetime"></td>\n        <td class="stakingrewardrow_balance numeric"></td>\n        <td class="stakingrewardrow_earnings numeric"></td>\n        <td class="stakingrewardrow_deposit numeric"></td>\n        <td class="stakingrewardrow_withdrawal numeric"></td>\n    </tr>\n</template>\n<div class="table-responsive">\n    <table class="table table-sm">\n        <thead class="table-dark">\n            <th scope="col">\n                date\n            </th>\n            <th scope="col">\n                balance\n            </th>\n            <th scope="col">\n                earnings\n            </th>\n            <th scope="col">\n                deposits\n            </th>\n            <th scope="col">\n                withdrawals\n            </th>\n        </thead>\n        <tbody id="stakingrewardstable">\n\n        </tbody>\n        <tfoot class="table-dark">\n            <th scope="col">\n                \n            </th>\n            <th scope="col">\n                \n            </th>\n            <th scope="col" id="totalEarnings" class="numeric">\n                \n            </th>\n            <th scope="col" class="numeric">\n                \n            </th>\n            <th scope="col" class="numeric">\n                \n            </th>\n        </tfoot>\n    </table>\n</div>\n\n</div>\n',this.stakingRewardsTable=this.shadowRoot.getElementById("stakingrewardstable"),document.querySelectorAll("link").forEach((t=>this.shadowRoot.appendChild(t.cloneNode())));const t=this.shadowRoot.querySelector("#accountselect");await Promise.all((await kt()).map((async e=>{const n=document.createElement("option");n.value=e,n.text=e,t.appendChild(n)})));const e=this.shadowRoot.querySelector("#currencyselect");(await Vt()).forEach((t=>{const n=document.createElement("option");n.value=t,n.text=t.toUpperCase(),e.appendChild(n)}));const n=()=>{const n=t.value,a=e.value;this.updateView(n,a,2)};return t.addEventListener("change",n),e.addEventListener("change",n),this.shadowRoot}async updateView(t,e,n){const a=await jt(t),o=this.shadowRoot.getElementById("stakingpoolselectoption"),s=this.shadowRoot.getElementById("stakingpoolselect");for(;s.lastElementChild;)s.removeChild(s.lastElementChild);a.forEach((async a=>{const i=o.cloneNode(!0).content;i.querySelector("input").id=a,i.querySelector("label").htmlFor=a,i.querySelector("label").innerHTML=a,i.querySelector("input").addEventListener("click",(async()=>{const o=await Lt(t,a),s=this.shadowRoot.querySelector("#stakingrewardrowtemplate");let i=0;for(;this.stakingRewardsTable.lastElementChild;)this.stakingRewardsTable.removeChild(this.stakingRewardsTable.lastElementChild);for(let t=0;t<o.length;t++){const a=s.cloneNode(!0).content,r=o[t],c=r.timestamp.substring(0,10),l="near"==e?1:await Wt(e,c),d=l*r.earnings/1e24;i+=d;const h=l*r.deposit/1e24,u=l*r.withdrawal/1e24;a.querySelector(".stakingrewardrow_datetime").innerHTML=c,a.querySelector(".stakingrewardrow_balance").innerHTML=(l*(r.balance/1e24)).toFixed(n),a.querySelector(".stakingrewardrow_earnings").innerHTML=d.toFixed(n),a.querySelector(".stakingrewardrow_deposit").innerHTML=h.toFixed(n),a.querySelector(".stakingrewardrow_withdrawal").innerHTML=u.toFixed(n),this.stakingRewardsTable.appendChild(a)}this.shadowRoot.querySelector("#totalEarnings").innerHTML=i.toFixed(n)})),s.appendChild(i)}));const i=this.shadowRoot.querySelector(".table-responsive");i.style.height=window.innerHeight-i.getBoundingClientRect().top+"px"}});customElements.define("customexchangerates-page",class extends HTMLElement{constructor(){super(),this.attachShadow({mode:"open"}),this.shadowRoot.innerHTML='\n<template id="customexchangeraterowtemplate">\n    <div class="input-group">\n        <input type="date" class="customexchangeratedate form-control"></td>\n        <input type="number" class="customexchangerateprice form-control"></td>\n        <select class="form-select customexchangeratecurrency" aria-label="Currency">\n        </select>\n        <select class="form-select customexchangeratebuysell" aria-label="Sell/Buy">\n            <option value="sell">Sell</option>\n            <option value="buy">Buy</option>\n        </select>\n        <button class="btn btn-danger removecustomexchangeratebutton"><i class="bi bi-trash"></i></button>\n    </div>\n</template>\n\n<div class="card">\n    <div class="card-header">Custom exchange rates</div>\n    <div class="card-body">\n        <div id="customexchangeratestable"></div>\n    </div>\n    <div class="card-footer">\n        <button id="addcustomexchangeratebutton" class="btn btn-primary">Add custom exchange rate</button>\n    </div>\n</div>\n',document.querySelectorAll("link").forEach((t=>this.shadowRoot.appendChild(t.cloneNode()))),this.shadowRoot.querySelector("#addcustomexchangeratebutton").onclick=async()=>{this.addCustomExchangeRateRow(),await this.storeCustomExchangeRates()},this.customExchangeRatesTable=this.shadowRoot.querySelector("#customexchangeratestable"),this.loadExistingCustomExchangeRates()}async loadExistingCustomExchangeRates(){(await async function(){const t=await qt(),e=[];return Object.keys(t).forEach((n=>{Object.keys(t[n]).forEach((a=>{t[n][a].buy&&e.push({date:a,currency:n,price:t[n][a].buy,buysell:"buy"}),t[n][a].sell&&e.push({date:a,currency:n,price:t[n][a].sell,buysell:"sell"})}))})),e}()).forEach((t=>this.addCustomExchangeRateRow(t)))}async storeCustomExchangeRates(){const t=Array.from(this.customExchangeRatesTable.children).map((t=>({date:t.querySelector(".customexchangeratedate").value,currency:t.querySelector(".customexchangeratecurrency").value,price:t.querySelector(".customexchangerateprice  ").valueAsNumber,buysell:t.querySelector(".customexchangeratebuysell").value})));await Ft(t)}async addCustomExchangeRateRow(t={}){const e=this.shadowRoot.querySelector("#customexchangeraterowtemplate");this.customExchangeRatesTable.appendChild(e.content.cloneNode(!0));const n=this.customExchangeRatesTable.lastElementChild,a=n.querySelector(".customexchangeratecurrency");(await Vt()).forEach((t=>{const e=document.createElement("option");e.value=t,e.text=t.toUpperCase(),a.appendChild(e)}));const o=n.querySelector(".customexchangeratedate"),s=n.querySelector(".customexchangerateprice"),i=n.querySelector(".customexchangeratebuysell");a.value=t.currency,o.value=t.date,s.value=t.price,i.value=t.buysell,[o,a,s,i].forEach((t=>t.addEventListener("change",(async t=>await this.storeCustomExchangeRates())))),n.querySelector(".removecustomexchangeratebutton").onclick=async()=>{n.remove(),await this.storeCustomExchangeRates()}}});const Gt={nodeUrl:"https://rpc.mainnet.near.org",walletUrl:"https://wallet.near.org",helperUrl:"https://helper.mainnet.near.org",contractName:"wasmgit.near",deps:{}},Xt=async()=>{Gt.deps.keyStore=new i.keyStores.BrowserLocalStorageKeyStore;const t=await i.connect(Gt);return new i.WalletConnection(t,"wasmgit")};customElements.define("storage-page",class extends HTMLElement{constructor(){super(),this.attachShadow({mode:"open"}),this.readyPromise=this.loadHTML()}async loadHTML(){return this.shadowRoot.innerHTML='<div class="card">\n    <div class="card-header">Store data on a git server</div>\n    <div class="card-body">\n        <p>You may store a remote copy of your data in a git server, which you can then use to synchronize with other browsers and devices</p>\n\n        <p>Enter wasm-git access key</p>\n        <p>\n            <input id="wasmgitaccesskey" type="password" /> <span id="wasmgitaccountspan"></span>\n        </p>\n        <p>\n        <label for="remoterepo" class="form-label">URL to git repository</label>\n        <input type="text" class="form-control" id="remoterepo" placeholder="https://wasm-git.petersalomonsen.com/YOUR_ACCOUNT-nearsight">\n        </p>\n        <button class="btn btn-primary" id="syncbutton">Synchronize</button>\n        <button class="btn btn-primary" id="deletelocaldatabutton">Delete local data</button>\n        <button class="btn btn-primary" id="downloadzipbutton">Download as zip file</button>\n    </div>\n</div>\n<br />\n<div class="card">\n    <div class="card-header">Fetch exchange rates</div>\n    <div class="card-body">\n        <p>Fetch exchange rates from various sources and store in your git repository</p>\n        \n        <p>\n        <button class="btn btn-primary" id="fetchnearusdbutton">Fetch NEAR/USD rates from nearblocks.io</button>\n        <button class="btn btn-primary" id="fetchusdnokbutton">Fetch USD/NOK rates from Norges Bank</button>\n        </p>\n\n        <br />\n        <h3>Yahoo finance</h3>\n        <p>Download historical prices from <a href="https://finance.yahoo.com/quote/NEAR-USD/history">https://finance.yahoo.com/quote/NEAR-USD/history</a>, and upload the file here</p>\n\n        <input type="file" id="yahoofinancecsvfileinput" class="form-control" placeholder="Upload Yahoo CSV">\n        <button class="btn btn-primary" id="importnearusdyahoobutton">Import NEAR/USD rates from Yahoo finance</button>\n    </div>\n</div>\n<br />',document.querySelectorAll("link").forEach((t=>this.shadowRoot.appendChild(t.cloneNode()))),this.shadowRoot.getElementById("fetchnearusdbutton").addEventListener("click",(async()=>{console.log("click"),c("indeterminate","Fetching NEAR/USD prices from nearblocks.io"),await Kt(),c(null)})),this.shadowRoot.getElementById("importnearusdyahoobutton").addEventListener("click",(async()=>{c("indeterminate","Fetching NEAR/USD prices from Yahoo finance");const t=await new Promise((t=>{const e=this.shadowRoot.getElementById("yahoofinancecsvfileinput"),n=new FileReader;n.onload=()=>t(n.result),n.readAsText(e.files[0])}));await async function(t){const e=t.split(/\n/),n=await Ot(Pt,"USD");e.slice(1).forEach((t=>{const e=t.split(",");n[e[0]]=parseFloat(e[4])})),await Dt(Pt,"USD",n)}(t),c(null)})),this.shadowRoot.getElementById("fetchusdnokbutton").addEventListener("click",(async()=>{c("indeterminate","Fetching USD/NOK rates from Norges Bank"),await async function(){const t=await fetch("https://data.norges-bank.no/api/data/EXR/B.USD.NOK.SP?format=sdmx-json&startPeriod=2020-01-01&endPeriod="+(new Date).toJSON().substring(0,10)+"&locale=en").then((t=>t.json())),e=t.data.dataSets[0].series["0:0:0:0"].observations,n={},a={},o=await Ot(Pt,"USD");t.data.structure.dimensions.observation.find((t=>"TIME_PERIOD"===t.id)).values.forEach(((t,n)=>{const o=t.id;a[o]=Number(e[n][0])}));const s=Object.keys(o).sort();let i=0;for(const t of s){const e=o[t],s=a[t];s?i=s:a[t]=i,n[t]=a[t]*e}await Dt(Pt,"NOK",n),await Dt("USD","NOK",a)}(),c(null)})),this.shadowRoot.getElementById("wasmgitaccesskey").addEventListener("change",(async t=>{const[e,n]=t.target.value.split(":");await async function(t,e){const n=i.utils.KeyPair.fromString(e);localStorage.setItem("wasmgit_wallet_auth_key",JSON.stringify({accountId:t,allKeys:[n.publicKey.toString()]})),await Gt.deps.keyStore.setKey(Gt.networkId,t,n)}(e,n),await this.loadAccountData(),this.shadowRoot.getElementById("wasmgitaccountspan").innerText=e})),this.deletelocaldatabutton=this.shadowRoot.querySelector("#deletelocaldatabutton"),this.deletelocaldatabutton.addEventListener("click",(async()=>{console.log("delete local data"),this.deletelocaldatabutton.disabled=!0,await async function(){await u("deletelocal",[])}(),location.reload()})),this.downloadzipbutton=this.shadowRoot.querySelector("#downloadzipbutton"),this.downloadzipbutton.addEventListener("click",(()=>{y()})),await this.loadAccountData(),this.remoteRepoInput=this.shadowRoot.querySelector("#remoterepo"),this.remoteRepoInput.addEventListener("change",(async()=>{await f(this.remoteRepoInput.value)})),this.remoteRepoInput.value=await async function(){const t=(await u("getremote",[])).result;return t?t.split("\n")[0].split(/\s+/)[1]:null}(),this.syncbutton=this.shadowRoot.querySelector("#syncbutton"),this.syncbutton.addEventListener("click",(async()=>{if(this.remoteRepoInput.value){c("indeterminate","syncing with remote");try{this.syncbutton.disabled=!0,await g(".git")?(await b(),await async function(){await u("sync",[])}(),this.dispatchSyncEvent()):2==(await async function(t){return(await u("readdir",{path:t})).result}(".")).length?await async function(t){return(await u("git",["clone",t,"."])).result}(this.remoteRepoInput.value):(await async function(){return(await u("git",["init","."])).result}(),await this.loadAccountData(),await f(this.remoteRepoInput.value),await b(),await async function(){await u("git",["push"])}())}catch(t){console.error(t),await T("Error syncing with remote",t)}c(null),this.syncbutton.disabled=!1}})),this.shadowRoot}dispatchSyncEvent(){this.dispatchEvent(new Event("sync"))}async loadAccountData(){let t={accountId:(await Xt()).getAccountId()};if(!t.accountId)return;const e=await async function(){const t=await Xt(),e=t.getAccountId(),n=btoa(JSON.stringify({accountId:e,iat:(new Date).getTime()})),a=await t.account().connection.signer.signMessage((new TextEncoder).encode(n),e);return n+"."+btoa(String.fromCharCode(...a.signature))}(),n=await async function(t){return(await u("configureuser",t)).result}({accessToken:e,useremail:t.accountId,username:t.accountId});console.log("configure user result",n)}});const Zt={};function Qt(t){return t?Zt[t].decimalConversionValue:Math.pow(10,-24)}async function te(t){const e=await kt(),n=e.reduce(((t,e)=>(t[e]=!0,t)),{}),a={},o={},s={},i={},r=await yt(),c=await async function(){return await g(mt)?JSON.parse(await m(mt)):{}}();let l=Math.pow(10,-24);for(let c of e){const e=(await St(c,t)).filter((t=>void 0!==t.balance)),d=await vt(c);if(t&&e.length>0){const t=e[0];Zt[t.ft.symbol]||(Zt[t.ft.symbol]=t.ft,Zt[t.ft.symbol].decimalConversionValue=Math.pow(10,-Zt[t.ft.symbol].decimals))}for(let a=0;a<e.length;a++){const h=e[a];h.account=c,h.changedBalance=BigInt(h.balance)-(a<e.length-1?BigInt(e[a+1].balance):0n),h.visibleChangedBalance=Number(h.changedBalance)*l,n[h.signer_id]||i[h.signer_id]||!(h.changedBalance>0n)||r[h.signer_id]||r[h.involved_account_id]||!t&&d[h.hash]||(h.receivedBalance=h.changedBalance,h.changedBalance=0n),o[h.hash]||(o[h.hash]=[]),o[h.hash].push(h);const u=new Date(h.block_timestamp/1e6).toJSON().substring(0,10);s[u]||(s[u]=[]),s[u].unshift(h)}const h=await jt(c);a[c]={arr:e,stakingAccounts:h,stakingBalances:{}};for(let e of h){i[e]=!0;const n=await Lt(c,e,t);for(let t of n){const n=t.timestamp.substr(0,10),o=a[c].stakingBalances;o[n]||(o[n]={totalStakingBalance:0,totalEarnings:0}),null==o[n][e]&&(o[n][e]=t.balance,o[n].totalStakingBalance+=t.balance),o[n].totalEarnings+=t.earnings}}}const d={};let h,u=new Date(2020,0,1);const p=new Date,w={};for(;u.getTime()<p;){const t=u.toJSON().substring(0,10);if(d[t]={totalBalance:0,accountBalance:0,stakingBalance:0,stakingEarnings:0,deposit:0,withdrawal:0,received:0n},u=new Date(u.getFullYear(),u.getMonth(),u.getDate()+1),e.forEach((e=>{const n=a[e];n.stakingBalances[t]?(d[t].stakingBalance+=n.stakingBalances[t].totalStakingBalance,d[t].stakingEarnings+=n.stakingBalances[t].totalEarnings):h&&n.stakingBalances[h]&&(d[t].stakingBalance+=n.stakingBalances[h].totalStakingBalance)})),s[t]&&s[t].forEach((e=>{let n=BigInt(0);if(o[e.hash].forEach((e=>{n+=e.changedBalance,e.changedBalance=0n,e.receivedBalance&&(d[t].received+=e.receivedBalance,e.receivedBalance=0n)})),!i[e.signer_id]&&!i[e.receiver_id])if(n>=BigInt(0))d[t].deposit+=Number(n);else if(d[t].withdrawal+=-Number(n),c[e.hash]){const a=c[e.hash];d[t].customRealizationRates||(d[t].customRealizationRates=[]),d[t].customRealizationRates.push({currency:a.realizationCurrency,dateTime:a.realizationTime,amount:-n,price:a.realizationPrice})}w[e.account]=BigInt(e.balance)})),d[t].accountBalance=Object.values(w).reduce(((t,e)=>t+e),BigInt(0)),d[t].totalBalance=d[t].stakingBalance+Number(d[t].accountBalance),d[t].accounts=Object.assign({},w),h){const e=d[t].totalBalance-d[h].totalBalance,n=d[t].accountBalance-d[h].accountBalance,a=d[t].stakingBalance-d[h].stakingBalance,o=d[t].stakingEarnings;Object.assign(d[t],{totalChange:e,accountChange:n,stakingChange:a,stakingRewards:o})}h=t}return{dailyBalances:d,transactionsByDate:s,accounts:e}}async function ee(t,e,n){const a=!e||"near"===e,o=a?1:await Wt(e,n),s=o*(t.stakingRewards/1e24),i=o*(Number(t.received)/1e24),r=a?1:await async function(t,e,n){if(n&&"near"!==n)return await Wt(t,e,n);const a=await qt();return a[t]?.[e]?.buy??await Wt(t,e)}(e,n);return{stakingReward:s,received:i,deposit:r*(t.deposit/1e24),withdrawal:a?t.withdrawal/1e24:t.convertToCurrencyWithdrawalAmount,conversionRate:o}}async function ne(t,e,n,a){const o=!n?1:await Wt(n,a,e),s=Zt[e].decimalConversionValue,i=o*(Number(t.received)*s);return{stakingReward:o*(t.stakingRewards*s),received:i,deposit:o*(t.deposit*s),withdrawal:o*(t.withdrawal*s),conversionRate:o}}function ae(t){const e=t?Intl.NumberFormat(navigator.language,{style:"currency",currency:t}).format:Intl.NumberFormat(navigator.language).format;return t=>null==t||isNaN(t)?"":e(t)}function oe(t,e){if(!t){const t=document.createElement("style");t.innerHTML="\n.profit, .loss, .summary_profit, .summary_loss, .dailybalancerow_profit, .dailybalancerow_loss, #summarytablefooter {\n    display: none;\n}\n        ",e.appendChild(t)}}async function se({shadowRoot:t,token:e,year:n,month:a,periodLengthMonths:o,convertToCurrency:s,perRowFunction:i}){const{periodStartDate:r,periodEndDate:c}=function(t,e,n){const a=new Date(Date.UTC(t,e,1));let o=new Date(Date.UTC(t,e,1));o.setMonth(o.getMonth()+Number(n)),o.setDate(o.getDate()-1);const s=new Date(new Date((new Date).getTime()-864e5).toJSON().substring(0,10));return o>s&&(o=s),{periodStartDate:a,periodEndDate:o}}(n,a,o);return console.log(n,a,o,r,c),await async function({shadowRoot:t,token:e,periodStartDate:n,periodEndDate:a,convertToCurrency:o,perRowFunction:s}){let i=a,{dailyBalances:r,transactionsByDate:c}=await te(e);r=(await async function(t,e,n){if(!e)return{dailyBalances:t};const a=[],o=[],s=Qt(n);for(const i in t){const r=t[i];r.convertToCurrencyWithdrawalAmount=0;let c=0,l=0;if(r.received>0n||r.deposit>0||r.reward>0){const t=Number(r.received??0n)+r.deposit??0+r.reward??0,o=await Wt(e,i,n);a.push({date:i,initialAmount:t,remainingAmount:t,convertedValue:o*t*s,conversionRate:o,realizations:[]})}if(r.withdrawal>0){r.realizations=[];const t=(t,e)=>{let n=0;for(r.convertToCurrencyWithdrawalAmount+=t*e*s;a.length>0&&n<t;){const d=a[0];if(n+d.remainingAmount>t){const a=t-n,o=d.convertedValue*(a/d.initialAmount),h=a*s*e;d.remainingAmount-=a,n=t;const u=h-o;u>=0?c+=u:l+=-u;const p={date:i,amount:a,initialConvertedValue:o,convertedValue:h,profit:u>=0?u:0,conversionRate:e,loss:u<0?-u:0};d.realizations.push(p),r.realizations.push(Object.assign({},p,{position:Object.assign({},d,{realizations:void 0})}))}else{n+=d.remainingAmount;const t=e*d.remainingAmount*s,h=d.convertedValue*(d.remainingAmount/d.initialAmount),u=t-h;u>=0?c+=u:l+=-u;const p={date:i,amount:d.remainingAmount,convertedValue:t,initialConvertedValue:h,conversionRate:e,profit:u>=0?u:0,loss:u<0?-u:0};d.realizations.push(p),r.realizations.push(Object.assign({},p,{position:Object.assign({},d,{realizations:void 0})})),d.remainingAmount=0,o.push(d),a.shift()}}n<t&&console.error(`should not happen: withdrawn amount larger than available positions. wanted to withdraw: ${t}, available: ${n}`)},d=await Yt(e,i,n);let h=r.withdrawal;if(r.customRealizationRates)for(const n of r.customRealizationRates)h<Number(n.amount)&&console.error("custom realization with higher amount than withdrawal for day",n),e===n.currency&&(h-=Number(n.amount),t(Number(n.amount),n.price));h>0&&t(h,d),r.profit=c,r.loss=l}}return{openPositions:a,closedPositions:o,dailyBalances:t}}(r,o,e)).dailyBalances;const l=r,d=t.querySelector("#dailybalancestable");for(;d.lastElementChild;)d.removeChild(d.lastElementChild);const h=t.querySelector("#dailybalancerowtemplate"),u=ae(o);let p=0,m=0,g=0,w=0,b=0,f=0,y=0,k=0n,v=0,_=0;const S=e?Qt(e):Math.pow(10,-24),E=ae(),T=""===e?"NEAR":e,R=t=>`<span class="token_amount">${E(t*S)} ${T}</span>`;for(;i.getTime()>=n;){const r=i.toJSON().substring(0,10),E=h.cloneNode(!0).content,T=l[r],{stakingReward:x,received:$,deposit:C,withdrawal:N,conversionRate:B}=e?await ne(T,e,o,r):await ee(T,o,r);if(p+=x,g+=C,m+=$,w+=N,b+=T.profit??0,f+=T.loss??0,y+=T.stakingRewards,k+=T.received,v+=T.deposit,_+=T.withdrawal,T.convertedTotalBalance=B*(T.totalBalance*S),T.convertedAccountBalance=B*(Number(T.accountBalance)*S),T.convertedStakingBalance=B*(T.stakingBalance*S),T.convertedTotalChange=B*(T.totalChange*S),T.convertedAccountChange=B*(Number(T.accountChange)*S),T.convertedStakingChange=B*(T.stakingChange*S),E.querySelector(".dailybalancerow_datetime").innerText=r,E.querySelector(".dailybalancerow_totalbalance").innerHTML=`${u(T.convertedTotalBalance)} ${o?`<br />${R(T.totalBalance)}`:""}`,E.querySelector(".dailybalancerow_accountbalance").innerHTML=`${u(T.convertedAccountBalance)} ${o?`<br />${R(Number(T.accountBalance))}`:""}`,E.querySelector(".dailybalancerow_stakingbalance").innerHTML=`${u(T.convertedStakingBalance)} ${o?`<br />${R(T.stakingBalance)}`:""}`,E.querySelector(".dailybalancerow_change").innerHTML=`${u(T.convertedTotalChange)} ${o?`<br />${R(T.totalChange)}`:""}`,E.querySelector(".dailybalancerow_accountchange").innerHTML=`${u(T.convertedAccountChange)} ${o?`<br />${R(Number(T.accountChange))}`:""}`,E.querySelector(".dailybalancerow_stakingchange").innerHTML=`${u(T.convertedStakingChange)} ${o?`<br />${R(T.stakingChange)}`:""}`,E.querySelector(".dailybalancerow_stakingreward").innerHTML=`${u(x)} ${o?`<br />${R(T.stakingRewards)}`:""}`,E.querySelector(".dailybalancerow_received").innerHTML=`${u($)} ${o?`<br />${R(Number(T.received))}`:""}`,E.querySelector(".dailybalancerow_deposit").innerHTML=`${u(C)} ${o?`<br />${R(T.deposit)}`:""}`,E.querySelector(".dailybalancerow_withdrawal").innerHTML=`${u(N)} ${o?`<br />${R(T.withdrawal)}`:""}`,o&&(E.querySelector(".dailybalancerow_profit").innerText=u(T.profit)??"",E.querySelector(".dailybalancerow_loss").innerText=u(T.loss)??""),await s({transactionsByDate:c,datestring:r,row:E,decimalConversionValue:S,numDecimals:2}),T.realizations){E.querySelector(".inforow td table tbody").innerHTML=T.realizations.map((t=>`\n                <tr>\n                    <td>${t.position.date}</td>\n                    <td>${R(t.position.initialAmount)}</td>\n                    <td>${u(t.position.conversionRate)}</td>\n                    <td>${R(t.amount)}</td>\n                    <td>${u(t.conversionRate)}</td>\n                </tr>\n            `)).join("\n")}else E.querySelector(".inforow").remove();const A=n.toJSON().substring(0,10),L=a.toJSON().substring(0,10);(r.endsWith("12-31")||r.endsWith("01-01")||r===A||r===L||0!==T.totalChange||0!==$||0!==C||0!==N)&&d.appendChild(E),i=new Date(i.getTime()-864e5),t.querySelector("#totalreward").innerHTML=`${u(p)} ${o?`<br />${R(y)}`:""}`,t.querySelector("#totalreceived").innerHTML=`${u(m)} ${o?`<br />${R(Number(k))}`:""}`,t.querySelector("#totaldeposit").innerHTML=`${u(g)} ${o?`<br />${R(v)}`:""}`,t.querySelector("#totalwithdrawal").innerHTML=`${u(w)} ${o?`<br />${R(_)}`:""}`,o&&(t.querySelector("#totalprofit").innerText=u(b),t.querySelector("#totalloss").innerText=u(f))}const x=new Date(a.getTime()).toJSON().substring(0,10),$=new Date(n.getTime()).toJSON().substring(0,10);return{totalStakingReward:p,totalReceived:m,totalDeposit:g,totalWithdrawal:w,totalProfit:b,totalLoss:f,outboundBalance:r[x],inboundBalance:r[$]}}({shadowRoot:t,token:e,periodEndDate:c,periodStartDate:r,convertToCurrency:s,perRowFunction:i})}customElements.define("year-report-page",class extends HTMLElement{constructor(){super(),this.attachShadow({mode:"open"}),this.readyPromise=this.loadHTML()}async loadHTML(){this.shadowRoot.innerHTML='<style>\n    .numeric {\n        text-align: right;\n    }\n\n    .dailybalancerow_datetime {\n        white-space: nowrap;\n    }\n\n    .dailybalancerow_balance {\n        white-space: nowrap;\n    }\n\n    tr.inforow td {\n        font-size: 12px;   \n    }\n\n    @media screen {\n        .table-responsive {\n            max-height: 100%;\n        }\n\n        table thead,\n        table tfoot {\n            position: sticky;\n        }\n\n        table thead {\n            inset-block-start: 0;\n            top: 0;\n        }\n\n        table tfoot {\n            inset-block-end: 0;\n            bottom: 0;\n        }\n    }\n\n    @media print {\n        .table-responsive {\n            overflow: visible !important;\n            display: block;\n            width: 100%;\n            max-width: none;\n        }\n    }\n    .token_amount {\n        font-size: 12px;\n        white-space: nowrap;\n    }\n</style>\n<div class="row">\n    <div class="col-md-2">\n        <label for="yearselect" class="form-label">Select start year</label>   \n        <select id="yearselect" class="form-select"></select>\n    </div>\n    <div class="col-md-2">\n        <label for="monthselect" class="form-label">Select start month</label>   \n        <select id="monthselect" class="form-select"></select>        \n    </div>\n    <div class="col-md-2">\n        <label for="periodlengthmonths" class="form-label">Number of months</label>   \n        <input id="periodlengthmonths" class="form-control" type="number" min="1" value="12"></id>        \n    </div>\n    <div class="col-md-2">\n        <label for="tokenselect" class="form-label">Fungible token</label>\n        <select class="form-select" aria-label="Select fungible token" id="tokenselect">\n            <option value="">NEAR</option>\n        </select>        \n    </div>\n    <div class="col-md-2">\n        <label for="currencyselect" class="form-label">Currency</label>\n        <select class="form-select" aria-label="Select conversion currency" id="currencyselect">\n            <option value="">No conversion</option>\n        </select>        \n    </div>\n    <div class="col-md-2" style="text-align: right">\n        <button class="btn btn-light" id="print_all_tokens_button">Print (all tokens)</button>\n        <button class="btn btn-light" id="print_current_token_button">Print (selected token)</button>\n    </div>\n</div>\n\n<template id="dailybalancerowtemplate">\n    <tr>\n        <td class="dailybalancerow_datetime"></td>\n        <td class="dailybalancerow_totalbalance numeric"></td>\n        <td class="dailybalancerow_change numeric"></td>\n        <td class="dailybalancerow_accountbalance numeric"></td>\n        <td class="dailybalancerow_accountchange numeric"></td>\n        <td class="dailybalancerow_stakingbalance numeric"></td>\n        <td class="dailybalancerow_stakingchange numeric"></td>\n        <td class="dailybalancerow_stakingreward numeric"></td>\n        <td class="dailybalancerow_received numeric"></td>\n        <td class="dailybalancerow_deposit numeric"></td>\n        <td class="dailybalancerow_withdrawal numeric"></td>\n        <td class="dailybalancerow_profit numeric"></td>\n        <td class="dailybalancerow_loss numeric"></td>\n        <td><button class="btn btn-light show_transactions_button">&#128194;</button></td>\n    </tr>\n    <tr class="inforow bg-info">\n        <td colspan="14" >\n            <table class="table table-sm table-borderless">\n                <thead>\n                    <tr>\n                        <th scope="col">acquisition date</th>\n                        <th scope="col">acquired amount</th>\n                        <th scope="col">acquisition price</th>\n                        <th scope="col">realized amount</th>\n                        <th scope="col">realization price</th>\n                    </tr>\n                </thead>\n                <tbody></tbody>\n            </table>\n        </td>\n    </tr>\n</template>\n<div class="table-responsive">\n    <table class="table table-sm table-hover">\n        <thead class="table-dark">\n            <th scope="col">\n                date\n            </th>\n            <th scope="col">\n                total balance\n            </th>\n            <th scope="col">\n                change\n            </th>\n            <th scope="col">\n                account balance\n            </th>\n            <th scope="col">\n                change\n            </th>\n            <th scope="col">\n                staking balance\n            </th>\n            <th scope="col">\n                change\n            </th>\n            <th scope="col">\n                reward\n            </th>\n            <th scope="col">\n                ext received\n            </th>\n            <th scope="col">\n                deposit\n            </th>\n            <th scope="col">\n                withdrawals\n            </th>\n            <th scope="col">\n                profit\n            </th>\n            <th scope="col">\n                loss\n            </th>\n            <th>\n                &nbsp;\n            </th>\n        </thead>\n        <tbody id="dailybalancestable">\n\n        </tbody>\n        <tfoot class="table-dark">\n            <th scope="col">\n\n            </th>\n            <th scope="col">\n\n            </th>\n            <th scope="col">\n\n            </th>\n            <th scope="col">\n\n            </th>\n            <th scope="col">\n\n            </th>\n            <th scope="col">\n\n            </th>\n            <th scope="col">\n\n            </th>\n            <th scope="col" class="numeric" id="totalreward">\n\n            </th>\n            <th scope="col" class="numeric" id="totalreceived">\n\n            </th>\n            <th scope="col" class="numeric" id="totaldeposit">\n\n            </th>\n            <th scope="col" class="numeric" id="totalwithdrawal">\n\n            </th>\n            <th scope="col" class="numeric" id="totalprofit">\n\n            </th>\n            <th scope="col" class="numeric" id="totalloss">\n\n            </th>\n            <th></th>\n        </tfoot>\n    </table>\n</div>\n<div class="modal" tabindex="-1" id="show_transactions_modal">\n  <div class="modal-dialog modal-lg">\n    <div class="modal-content">\n      <div class="modal-header">\n        <h5 class="modal-title">Transactions</h5>\n        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>\n      </div>\n      <div class="modal-body">\n        <p>Modal body text goes here.</p>\n      </div>\n      <div class="modal-footer">\n        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>\n      </div>\n    </div>\n  </div>\n</div>\n',document.querySelectorAll("link").forEach((t=>this.shadowRoot.appendChild(t.cloneNode()))),this.year=(new Date).getFullYear(),this.yearSelect=this.shadowRoot.querySelector("#yearselect");for(let t=this.year;t>=2020;t--){const e=document.createElement("option");e.value=t,e.innerHTML=`${t}`,t===this.year&&(e.selected=!0),this.yearSelect.appendChild(e)}this.yearSelect.addEventListener("change",(()=>{this.year=parseInt(this.yearSelect.value),this.refreshView()})),this.month=0,this.monthSelect=this.shadowRoot.querySelector("#monthselect");for(let t=0;t<12;t++){const e=document.createElement("option");e.value=t,e.innerHTML=`${new Date(2020,t,1).toLocaleDateString("en-US",{month:"long"})}`,t===this.month&&(e.selected=!0),this.monthSelect.appendChild(e)}this.monthSelect.addEventListener("change",(()=>{this.month=parseInt(this.monthSelect.value),this.refreshView()}));const t=this.shadowRoot.querySelector("#periodlengthmonths");this.periodLengthMonths=parseInt(t.value),t.addEventListener("change",(()=>{this.periodLengthMonths=parseInt(t.value),this.refreshView()}));const e=this.shadowRoot.querySelector("#tokenselect");(await bt()).forEach((t=>{const n=document.createElement("option");n.value=t,n.text=t,e.appendChild(n)}));const n=this.shadowRoot.querySelector("#currencyselect");(await Vt()).forEach((t=>{const e=document.createElement("option");e.value=t,e.text=t.toUpperCase(),n.appendChild(e)}));return n.addEventListener("change",(()=>this.updateView(n.value,2,e.value))),e.addEventListener("change",(()=>this.updateView(n.value,2,e.value))),this.updateView(n.value,2,e.value),this.shadowRoot.querySelector("#print_current_token_button").addEventListener("click",(()=>{window.open(`year-report-print?token=${this.token}&year=${this.year}&month=${this.month}&nummonths=${this.periodLengthMonths}&currency=${this.convertToCurrency}`)})),this.shadowRoot.querySelector("#print_all_tokens_button").addEventListener("click",(()=>{window.open(`yearsummary-alltokens-print?year=${this.year}&month=${this.month}&nummonths=${this.periodLengthMonths}&currency=${this.convertToCurrency}`)})),this.transactionsModalElement=this.shadowRoot.querySelector("#show_transactions_modal"),this.showTransactionsModal=new bootstrap.Modal(this.transactionsModalElement),this.shadowRoot}async updateView(t,e,n){this.convertToCurrency=t,this.numDecimals=e,this.token=n,await this.refreshView()}async refreshView(){await se({shadowRoot:this.shadowRoot,token:this.token,month:this.month,periodLengthMonths:this.periodLengthMonths,year:this.year,convertToCurrency:this.convertToCurrency,numDecimals:this.numDecimals,perRowFunction:async({datestring:t,transactionsByDate:e,decimalConversionValue:n,numDecimals:a,row:o})=>{o.querySelector(".show_transactions_button").addEventListener("click",(()=>{const a=e[t].sort(((t,e)=>Number(BigInt(t.block_timestamp)-BigInt(e.block_timestamp))));this.transactionsModalElement.querySelector(".modal-title").innerHTML=`Transactions ${t}`,this.transactionsModalElement.querySelector(".modal-body").innerHTML=`\n                <div class="table-responsive">\n                    <table class="table table-sm table-dark">\n                    <thead>\n                        <th>Time</th>\n                        <th>Signer</th>\n                        <th>Received</th>                        \n                        <th>Changed balance</th>\n                        <th>Attached deposit</th>\n                        <th></th>\n                    </thead>\n                    <tbody>\n                    ${a?a.map((t=>`<tr>\n                        <td>${new Date(Number(BigInt(t.block_timestamp)/1000000n)).toJSON().substring(11)}</td>\n${this.token?`<td>${t.involved_account_id}</td><td>${t.affected_account_id}</td><td>${t.delta_amount*n}</td>`:`<td>${t.signer_id}</td><td>${t.receiver_id}</td><td>${t.visibleChangedBalance}</td>`}\n<td>${nearApi.utils.format.formatNearAmount(t.args?.deposit)}</td>\n<td><a class="btn btn-light" target="_blank" href="https://nearblocks.io/txns/${t.hash}">&#128194;</button></a>\n</tr>`)).join(""):""}\n                    </tbody>\n                    </table>\n                    </div>\n                `,this.showTransactionsModal.show()}));const s=this.shadowRoot.querySelector(".table-responsive");s.style.height=window.innerHeight-s.getBoundingClientRect().top+"px"}})}});customElements.define("year-report-print",class extends HTMLElement{constructor(){super(),this.attachShadow({mode:"open"}),this.shadowRoot.innerHTML='<style>\n    .numeric {\n        text-align: right;\n    }\n\n    .dailybalancerow_datetime {\n        white-space: nowrap;\n    }\n\n    .dailybalancerow_balance {\n        white-space: nowrap;\n    }\n\n    tr.inforow td {\n        font-size: 12px;   \n    }\n\n    #transactionstablebody td:nth-child(2) {\n        max-width: 300px;\n        overflow: hidden;\n        text-overflow: ellipsis;\n        white-space: nowrap;\n    }\n    #transactionstablebody td:nth-child(3) {\n        max-width: 300px;\n        overflow: hidden;\n        text-overflow: ellipsis;\n        white-space: nowrap;\n    }\n    .pagebreak {\n        page-break-after: always;\n    }\n    .token_amount {\n        font-size: 12px;\n        white-space: nowrap;\n    }\n</style>\n<h1><span id="tokenspan"></span> <span id="currencyspan"></span> <span id="yearspan"></span></h1>\n\n<table class="table">\n<tr>\n    <td>Staking rewards</td>\n    <td class="numeric" id="totalreward"></td>\n</tr>\n<tr>\n    <td>Received (Earnings)</td>\n    <td class="numeric" id="totalreceived"></td>\n</tr>\n<tr>\n    <td>Total earnings (Staking rewards + Received)</td>\n    <td class="numeric" id="totalearnings"></td>\n</tr>\n<tr>\n    <td>Deposit</td>\n    <td class="numeric" id="totaldeposit"></td>\n</tr>\n<tr>\n    <td>Withdrawal</td>\n    <td class="numeric" id="totalwithdrawal"></td>\n</tr>\n<tr class="profit">\n    <td>Profit on realizations</td>\n    <td class="numeric" id="totalprofit"></td>\n</tr>\n<tr class="loss">\n    <td>Loss on realizations</td>\n    <td class="numeric" id="totalloss"></td>\n</tr>\n</table>\n        \n<template id="dailybalancerowtemplate">\n    <tr>\n        <td class="dailybalancerow_datetime"></td>\n        <td class="dailybalancerow_totalbalance numeric"></td>\n        <td class="dailybalancerow_change numeric"></td>\n        <td class="dailybalancerow_accountbalance numeric"></td>\n        <td class="dailybalancerow_accountchange numeric"></td>\n        <td class="dailybalancerow_stakingbalance numeric"></td>\n        <td class="dailybalancerow_stakingchange numeric"></td>\n        <td class="dailybalancerow_stakingreward numeric"></td>\n        <td class="dailybalancerow_received numeric"></td>\n        <td class="dailybalancerow_deposit numeric"></td>\n        <td class="dailybalancerow_withdrawal numeric"></td>\n        <td class="dailybalancerow_profit numeric"></td>\n        <td class="dailybalancerow_loss numeric"></td>\n    </tr>\n    <tr class="inforow bg-info">\n        <td colspan="13" >\n            <table class="table table-sm table-borderless">\n                <thead>\n                    <tr>\n                        <th scope="col">acquisition date</th>\n                        <th scope="col">acquired amount</th>\n                        <th scope="col">acquisition price</th>\n                        <th scope="col">realized amount</th>\n                        <th scope="col">realization price</th>\n                    </tr>\n                </thead>\n                <tbody></tbody>\n            </table>\n        </td>\n    </tr>\n</template>\n\n<div class="pagebreak"></div>\n\n<h1>Daily changes</h1>\n<p>\nThe following table shows the first and last day of the year, and each day where there are changes in the balance.\nAny transfer to other accounts than those reported for, are counted as withdrawals.\nIf there are withdrawals, and a target currency is selected, then profit or loss of the realizations relative to the currency are calculated, and displayed as a table under\nthe row for that day. Staking rewards are added without any transaction taking place, and the new staking balance\nis obtained by calling the staking contract for the balance for that specific date.\n</p>\n<table class="table table-sm table-hover">\n    <thead class="table-dark">\n        <th scope="col">\n            date\n        </th>\n        <th scope="col" class="numeric">\n            total balance\n        </th>\n        <th scope="col" class="numeric">\n            change\n        </th>\n        <th scope="col" class="numeric">\n            account balance\n        </th>\n        <th scope="col" class="numeric">\n            change\n        </th>\n        <th scope="col" class="numeric">\n            staking balance\n        </th>\n        <th scope="col" class="numeric">\n            change\n        </th>\n        <th scope="col" class="numeric">\n            reward\n        </th>\n        <th scope="col" class="numeric">\n            ext received\n        </th>\n        <th scope="col" class="numeric">\n            deposit\n        </th>\n        <th scope="col" class="numeric">\n            withdrawals\n        </th>\n        <th scope="col" class="numeric profit">\n            profit\n        </th>\n        <th scope="col" class="numeric loss">\n            loss\n        </th>\n    </thead>\n    <tbody id="dailybalancestable">\n\n    </tbody>\n</table>\n\n<div class="pagebreak"></div>\n\n<h1>Transactions</h1>\n<p>\nBelow are all the transactions recorded for the accounts. Transactions may be because of function calls to\nsmart contracts, transfers, adding access keys and more. The balance change is calculated by querying the account\nfor the balance before and after the transaction. The balance changes are viewed as token amounts, and not converted\nto the currency used above. Note that for each row there is a link to <a href="https://nearblocks.io">nearblocks.io</a> for\nmore details about the transaction.\n</p>\n<table class="table table-sm">\n<thead>\n    <tr>\n        <th>Date</th>\n        <th>Signer</th>\n        <th>Receiver</th>\n        <th>Type</th>\n        <th class="numeric">Changed balance</th>\n        <th></th>\n    </tr>\n</thead>\n<tbody id="transactionstablebody">\n</tbody>\n</table>\n';const t=new URLSearchParams(location.search);this.token=t.get("token"),this.year=t.get("year"),this.month=t.get("month"),this.periodLengthMonths=t.get("nummonths"),this.convertToCurrency=t.get("currency"),oe(this.convertToCurrency,this.shadowRoot),null!==this.token&&this.createReport()}useDataset(){this.year=this.dataset.year,this.month=this.dataset.month,this.periodLengthMonths=this.dataset.periodLengthMonths,this.convertToCurrency=this.dataset.currency,this.token=this.dataset.token,oe(this.convertToCurrency,this.shadowRoot)}async createReport(){this.shadowRoot.getElementById("yearspan").innerText=this.year,this.shadowRoot.getElementById("tokenspan").innerText=this.token?this.token:"NEAR",this.shadowRoot.getElementById("currencyspan").innerText=this.convertToCurrency,document.querySelectorAll("link").forEach((t=>this.shadowRoot.appendChild(t.cloneNode())));const t=this.shadowRoot.querySelector("#transactionstablebody"),e=ae(this.convertToCurrency),n=await se({shadowRoot:this.shadowRoot,token:this.token,year:this.year,month:this.month,periodLengthMonths:this.periodLengthMonths,convertToCurrency:this.convertToCurrency,numDecimals:this.numDecimals,perRowFunction:async({datestring:e,transactionsByDate:n,decimalConversionValue:a,numDecimals:o})=>{if(n[e]){const s=n[e];for(let n of s){const s=document.createElement("tr");s.innerHTML=`<td>\n                ${e}\n                </td>\n                ${this.token?`\n                <td>${n.involved_account_id}</td>\n                <td>${n.affected_account_id}</td>\n                <td>${n.cause}</td>\n            \n                <td class="numeric">${(n.delta_amount*a).toFixed(o)}</td>`:`<td>${n.signer_id}</td>\n                <td>${n.receiver_id}</td>\n                <td>${n.action_kind}</td>\n                <td class="numeric">${n.visibleChangedBalance.toFixed(o)}</td>`}\n                <td><a class="btn btn-light" target="_blank" href="https://nearblocks.io/txns/${n.hash}">&#128194;</a>\n                </td>`,t.appendChild(s)}}}});return this.shadowRoot.getElementById("totalearnings").innerText=e(n.totalReceived+n.totalStakingReward),n}});customElements.define("yearsummary-alltokens-print",class extends HTMLElement{constructor(){super(),this.attachShadow({mode:"open"}),this.shadowRoot.innerHTML='\n<style>\n    .numeric {\n        text-align: right;\n    }\n    .pagebreak {\n        page-break-after: always;\n    }\n</style>\n<h1>Year report <span id="yearspan"></span></h1>\n\n<p><b>Disclaimer:</b> <em>This report is based on the configurations of the user, and the calculations of the software that generated the report.\nReaders of this report, and users of the reporting tool should verify the correctness of the calculations, and ensure that all relevant data is collected.\n<b>The reporting software does not guarantee correctness in calculations or accuracy and completeness in the underlying data</b>. The source code of the\nreporting software is available at <a href="https://github.com/arizas/Ariz-Portfolio">https://github.com/arizas/Ariz-Portfolio</a>.\n</em></p>\n<p>This report is for activity in the following accounts on the <a href="https://near.org">NEAR protocol</a> blockchain: <span style="font-style: italic;" id="accountsspan"></span></p>\n\n<p>The following table shows the outbound balance, earnings. If a target currency is selected, it also shows profit/loss on realizations per fungible token relative to the currency.</p>\n\n<template id="symmaryrowtemplate">\n    <tr>\n        <td class="summary_token"></td>\n        <td class="summary_amount numeric"></td>\n        <td class="summary_balance numeric"></td>\n        <td class="summary_earnings numeric"></td>\n        <td class="summary_profit numeric"></td>\n        <td class="summary_loss numeric"></td>\n    </tr>\n</template>\n<table class="table">\n<thead>\n    <tr>\n        <th scope="col">\n            token\n        </th>\n        <th scope="col" class="numeric">\n            amount\n        </th>\n        <th scope="col" class="numeric">\n            balance\n        </th>\n        <th scope="col" class="numeric">\n            earnings\n        </th>\n        <th scope="col" class="numeric profit">\n            profit\n        </th>\n        <th scope="col" class="numeric loss">\n            loss\n        </th>\n    </tr>\n</thead>\n<tbody id="summarytablebody">\n</tbody>\n<tfoot id="summarytablefooter">\n    <tr>\n        <th>Total</th>\n        <th></th>\n        <th id="summary_total_balance" class="numeric"></th>\n        <th id="summary_total_earnings" class="numeric"></th>\n        <th id="summary_total_profit" class="numeric profit"></th>\n        <th id="summary_total_loss" class="numeric loss"></th>\n    </tr>\n</tfoot>\n</table>\n\n<p>In the following pages there are detailed reports for each fungible token.</p>\n\n<div id="tokenyearreports"></div>\n',document.querySelectorAll("link").forEach((t=>this.shadowRoot.appendChild(t.cloneNode())));const t=new URLSearchParams(location.search);this.year=t.get("year"),this.month=t.get("month"),this.periodLengthMonths=t.get("nummonths"),this.currency=t.get("currency"),oe(this.currency,this.shadowRoot),this.createReport()}async createReport(){const t=this.shadowRoot.getElementById("tokenyearreports"),e=["",...await bt()],n=this.shadowRoot.getElementById("summarytablebody"),a=this.shadowRoot.querySelector("#symmaryrowtemplate");this.shadowRoot.getElementById("accountsspan").innerText=(await kt()).join(", "),this.shadowRoot.getElementById("yearspan").innerText=this.year;const o=ae(this.currency),s=ae();let i=0,r=0,c=0,l=0;const d=await async function(){return await g(ht)?JSON.parse(await m(ht)):[]}();for(const h of e){if(d.find((t=>t.symbol===h)))continue;const e=document.createElement("year-report-print");e.dataset.year=this.year,e.dataset.month=this.month,e.dataset.periodLengthMonths=this.periodLengthMonths,e.dataset.currency=this.currency,e.dataset.token=h,e.useDataset();const u=await e.createReport();if(!isNaN(u.outboundBalance.convertedTotalBalance)&&(0!==u.totalReceived||0!==u.totalStakingReward||0!==u.totalDeposit||0!==u.totalWithdrawal)){const d=document.createElement("div");d.classList.add("pagebreak"),t.appendChild(d),t.appendChild(e);const p=h?Qt(h):Math.pow(10,-24),m=a.cloneNode(!0).content,g=u.totalReceived+u.totalStakingReward;m.querySelector(".summary_token").innerText=""===h?"NEAR":h,m.querySelector(".summary_amount").innerText=s(u.outboundBalance.totalBalance*p),m.querySelector(".summary_balance").innerText=o(u.outboundBalance.convertedTotalBalance),m.querySelector(".summary_earnings").innerText=o(g),m.querySelector(".summary_profit").innerText=o(u.totalProfit),m.querySelector(".summary_loss").innerText=o(u.totalLoss),n.appendChild(m),i+=u.outboundBalance.convertedTotalBalance,r+=g,c+=u.totalProfit,l+=u.totalLoss,this.shadowRoot.getElementById("summary_total_balance").innerText=o(i),this.shadowRoot.getElementById("summary_total_earnings").innerText=o(r),this.shadowRoot.getElementById("summary_total_profit").innerText=o(c),this.shadowRoot.getElementById("summary_total_loss").innerText=o(l)}}}});const ie=import.meta.url.substring(0,import.meta.url.lastIndexOf("/")+1),re=ie.substring(location.origin.length),ce=document.querySelector("#navbarNavAltMarkup");Array.from(document.getElementsByClassName("nav-link")).forEach((t=>{const e=t.dataset.page;t.onclick=()=>{if(goToPage(e),ce.classList.contains("navbar-collapse")){new bootstrap.Collapse(ce).hide()}return!1}}));class le extends HTMLElement{constructor(){super(),this.attachShadow({mode:"open"}),this.shadowRoot.innerHTML='\n<style>\n@media print {\n    .container {\n        width: 100% !important; /* Ensures the container takes full width */\n        margin: 0 !important; /* Removes horizontal margins */\n        max-width: none !important; /* Ensures there\'s no max-width limit */\n        padding: 0 !important; /* Removes padding if there\'s any */\n        min-width: 0 !important; /* Ensures there\'s no min-width limit */\n        position: static !important; /* Resets position property */\n        float: none !important; /* Avoids floating */\n        border: none !important; /* Removes any borders */\n        box-shadow: none !important; /* Clears box shadows */\n    }\n}\n</style>\n<nav class="navbar navbar-expand-md navbar-dark bg-dark">\n    <div class="container-fluid">\n        <a class="navbar-brand nav-link" href="/">NEAR account report</a>\n        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNavAltMarkup"\n            aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation">\n            <span class="navbar-toggler-icon"></span>\n        </button>\n        <div class="collapse navbar-collapse" id="navbarNavAltMarkup">\n            <div class="navbar-nav">                    \n                <a class="nav-item nav-link" href="/year-report" data-page="year-report">Year report</a>\n                <a class="nav-item nav-link" href="/transactions" data-page="transactions">Transactions</a>\n                <a class="nav-item nav-link" href="/staking" data-page="staking">Staking rewards</a>\n                <a class="nav-item nav-link" href="/customexchangerates" data-page="customexchangerates">Custom exchange rates</a>\n                <a class="nav-item nav-link" href="/accounts" data-page="accounts">Accounts</a>\n                <a class="nav-item nav-link" href="/storage" data-page="storage">Storage</a>\n                <button id="loginbutton" class="nav-item nav-button">Login</button>\n            </div>\n        </div>\n    </div>\n    \n</nav>\n\n<nav class="navbar navbar-light bg-light small">\n    <div id="attributions" class="container">\n        <div class="navbar-text">\n            Powered by <a href="https://nearblocks.io">Nearblocks.io</a> APIs, <a href="https://fastnear.com">FastNEAR</a> and <a href="https://1rpc.io">1rpc.io</a> RPCs.\n        </div>\n    </div>\n</nav>\n<br />\n<div class="container" id="mainContainer">\n    Get an overview of your NEAR accounts. See your transactions, staking rewards,\n    and get an annual report calculating profit and loss for each of your transactions.\n</div>\n',document.querySelectorAll("link").forEach((t=>this.shadowRoot.appendChild(t.cloneNode())));const t=this.shadowRoot.querySelector("#mainContainer");if(window.goToPage=e=>{const n=document.createElement(`${e}${e.endsWith("-print")?"":"-page"}`),a=`${re}${e}`;window.top!=window||location.pathname==a&&0!=location.search.indexOf("?account_id")||history.pushState({},null,a),e.endsWith("-print")&&this.shadowRoot.querySelector("nav").remove(),t.replaceChildren(n)},location.href!=ie){location.href.substring(ie.length).replace(/\/$/,"").split("?")[0]&&goToPage(location.href.substring(ie.length).replace(/\/$/,"").split("?")[0])}this.shadowRoot.querySelectorAll("a").forEach((t=>{t.dataset.page&&(t.onclick=e=>{e.preventDefault(),window.goToPage(t.dataset.page)})}));const e=this.shadowRoot.querySelector("#loginbutton");e.addEventListener("click",(async()=>{await B()?(!async function(){(await N()).signOut()}(),e.innerHTML="Login"):async function(){if(await E("Login to Ariz gateway",'\n        By logging in to the Ariz gateway, you will get access to conversion rates for many currencies.\n        If you click "yes", you will be redirected to <b>MyNearWallet</b> for signing into the Ariz Portfolio contract. After signing in\n        you will be prompted to pay 0.2 NEAR for registering an access token to the Ariz gateway on this device. The access token\n        will be valid in 5 minutes, and will have to be renewed if requesting more data from the Ariz gateway. The renewal cost is only the gas\n        for the smart contract call.\n    ')){const t=await N();await t.requestSignIn({contractId:x,successUrl:location.origin,failureUrl:location.origin})}}()})),setTimeout((async()=>{await B()&&(e.innerHTML="Logout")}),0)}}customElements.define("app-near-account-report",le);
</script></body></html>